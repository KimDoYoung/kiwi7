# LS증권 API 사용 현황

Lucy 2.0에서 사용하는 LS증권 API 목록입니다.

## 파일 위치

| 파일 | 설명 |
|------|------|
| `backend/app/domains/stc/ls/ls_stock_api.py` | REST API 클라이언트 |
| `backend/app/domains/stc/ls/ls_ws_task.py` | WebSocket 처리 |
| `backend/app/utils/ls_ws_util.py` | WebSocket 유틸리티 |
| `backend/app/domains/stc/ls/model/` | 요청/응답 모델 (22개 파일) |

---

## REST API 목록

### 1. 시세 조회 API

**API 경로**: `/stock/market-data`

#### 1.1 현재가 조회 (단일)
| 항목 | 내용 |
|------|------|
| **TR CD** | `t1102` |
| **메서드** | `current_cost()` |
| **용도** | 단일 종목의 현재가, 등락률, 거래량 등 상세 시세 조회 |
| **요청** | `shcode`: 종목코드 (예: "005930") |
| **응답** | 한글명, 현재가, 전일대비, 등락률, 거래량, 52주 최고/최저가, PER, PBR 등 약 150개 필드 |

#### 1.2 멀티 현재가 조회
| 항목 | 내용 |
|------|------|
| **TR CD** | `t8407` |
| **메서드** | `multi_current_cost()` |
| **용도** | 최대 50개 종목의 현재가를 한 번에 조회 |
| **요청** | `nrec`: 조회 건수 (최대 50), `shcode`: 종목코드 연속 입력 |
| **응답** | 종목별 현재가, 등락률, 거래량, 호가, 체결강도, 시가/고가/저가 |

#### 1.3 종목 마스터 조회
| 항목 | 내용 |
|------|------|
| **TR CD** | `t9945` |
| **메서드** | `master_api()` |
| **용도** | KSP(유가증권) 또는 KSD(코스닥) 전체 종목 마스터 데이터 조회 |
| **요청** | `gubun`: "1"(KSP), "2"(KSD) |
| **응답** | 종목명, 단축코드, 확장코드, ETF 구분 |

---

### 2. 상위종목 순위 API

**API 경로**: `/stock/high-item`

#### 2.1 등락률 상위
| 항목 | 내용 |
|------|------|
| **TR CD** | `t1441` |
| **메서드** | `rank_range()` |
| **용도** | 상승률/하락률 상위 종목 조회 |
| **요청** | `gubun1`: 시장 (0=전체, 1=코스피, 2=코스닥), `gubun2`: 상승/하락/보합, `gubun3`: 당일/전일, `sprice`/`eprice`: 가격범위, `volume`: 거래량필터 |
| **응답** | 종목명, 현재가, 등락률, 거래량, 시가/고가/저가, 거래대금, 시가총액 |

#### 2.2 거래량 상위
| 항목 | 내용 |
|------|------|
| **TR CD** | `t1452` |
| **메서드** | `rank_volumn()` |
| **용도** | 거래량 상위 종목 조회 |

#### 2.3 전일 동시간대비 거래급증
| 항목 | 내용 |
|------|------|
| **TR CD** | `t1466` |
| **메서드** | `rank_rapidup()` |
| **용도** | 전일 동시간 대비 거래량 급증 종목 |

#### 2.4 시간외 등락률 상위
| 항목 | 내용 |
|------|------|
| **TR CD** | `t1481` |
| **메서드** | `rank_timeout_range()` |
| **용도** | 시간외 거래 등락률 상위 |

#### 2.5 시간외 거래량 상위
| 항목 | 내용 |
|------|------|
| **TR CD** | `t1482` |
| **메서드** | `rank_timeout_volume()` |
| **용도** | 시간외 거래량 상위 |

#### 2.6 예상체결량 상위
| 항목 | 내용 |
|------|------|
| **TR CD** | `t1489` |
| **메서드** | `rank_expect_filfull()` |
| **용도** | 예상 체결량 상위 종목 |

#### 2.7 단일가 예상 등락률 상위
| 항목 | 내용 |
|------|------|
| **TR CD** | `t1492` |
| **메서드** | `rank_expect_danilga_range()` |
| **용도** | 단일가 예상 등락률 상위 |

#### 2.8 거래대금 상위
| 항목 | 내용 |
|------|------|
| **TR CD** | `t1463` |
| **메서드** | `rank_purchase_cost()` |
| **용도** | 거래대금 상위 종목 |

---

### 3. 주문 API

**API 경로**: `/stock/order`

#### 3.1 현물 신규 주문
| 항목 | 내용 |
|------|------|
| **TR CD** | `CSPAT00601` |
| **메서드** | `order()` |
| **용도** | 주식 매매 주문 접수 |
| **요청** | - `IsuNo`: 종목번호 (A+종목코드)<br>- `OrdQty`: 주문수량<br>- `OrdPrc`: 주문가<br>- `BnsTpCode`: 매매구분 ("1"=매도, "2"=매수)<br>- `OrdprcPtnCode`: 호가유형<br>- `MgntrnCode`: 신용거래코드 (기본: "000")<br>- `OrdCndiTpCode`: 주문조건 ("0"=없음, "1"=IOC, "2"=FOK) |
| **응답** | 주문번호, 주문시각, 주문금액, 계좌명, 종목명 |

#### 3.2 현물 정정 주문
| 항목 | 내용 |
|------|------|
| **TR CD** | `CSPAT00701` |
| **메서드** | `modify_cash()` |
| **용도** | 기존 주문 수정 |
| **요청** | `OrgOrdNo`: 원주문번호, `IsuNo`: 종목번호, `OrdQty`: 변경수량, `OrdPrc`: 변경가격 |
| **응답** | 원주문번호, 변경 후 주문번호, 주문시각 |

#### 3.3 현물 취소 주문
| 항목 | 내용 |
|------|------|
| **TR CD** | `CSPAT00801` |
| **메서드** | `cancel_cash()` |
| **용도** | 기존 주문 취소 |
| **요청** | `OrgOrdNo`: 원주문번호, `IsuNo`: 종목번호, `OrdQty`: 취소수량 |
| **응답** | 취소 주문번호, 취소 시각, 계좌명, 종목명 |

### 호가유형 코드 (OrdprcPtnCode)

| 코드 | 설명 |
|------|------|
| 00 | 지정가 |
| 03 | 시장가 |
| 05 | 조건부지정가 |
| 06 | 최유리지정가 |
| 07 | 최우선지정가 |
| 61 | 장개시전 시간외종가 |
| 81 | 시간외종가 |
| 82 | 시간외단일가 |

---

### 4. 계좌 조회 API

**API 경로**: `/stock/accno`

#### 4.1 계좌별 거래내역 및 잔고
| 항목 | 내용 |
|------|------|
| **TR CD** | `CDPCQ04700` |
| **메서드** | `acct_history()` |
| **용도** | 계좌의 입출금, 입출고, 매매, 환전 등 거래내역과 잔고 조회 |
| **요청** | - `QryTp`: 조회구분 ("0"=전체, "1"=입출금, "2"=입출고, "3"=매매, "4"=환전, "9"=기타)<br>- `QrySrtDt`, `QryEndDt`: 조회기간<br>- `SrtNo`: 시작번호<br>- `IsuLgclssCode`: 종목대분류 ("01"=주식, "02"=채권, "04"=펀드 등)<br>- `IsuNo`: 종목번호 (선택) |
| **응답** | 거래내역 (거래일, 거래종류, 수량, 단가, 금액, 수수료, 제세금, 수익금), 손익합계, 입출금 요약 |

#### 4.2 체결/미체결 조회 (HTS용)
| 항목 | 내용 |
|------|------|
| **TR CD** | `t0425` |
| **메서드** | `fulfill_list()` |
| **용도** | 주문 체결 현황 조회 |
| **요청** | - `expcode`: 종목번호<br>- `chegb`: 체결구분 ("0"=전체, "1"=체결, "2"=미체결)<br>- `medosu`: 매매구분 ("0"=전체, "1"=매도, "2"=매수)<br>- `sortgb`: 정렬순서 |
| **응답** | 총주문수량, 총체결수량, 총미체결수량, 추정수수료, 추정제세금, 주문별 상세 |

#### 4.3 체결/미체결 조회 (OpenAPI용)
| 항목 | 내용 |
|------|------|
| **TR CD** | `CSPAQ13700` |
| **메서드** | `fulfill_api_list()` |
| **용도** | OpenAPI용 주문 체결 현황 조회 |
| **요청** | - `OrdMktCode`: 주문시장 ("00"=전체, "10"=거래소, "20"=코스닥)<br>- `BnsTpCode`: 매매구분<br>- `IsuNo`: 종목번호<br>- `ExecYn`: 체결여부<br>- `OrdDt`: 주문일 |
| **응답** | 매도/매수 체결/주문 요약, 상세 주문내역 |

#### 4.4 주식잔고 조회
| 항목 | 내용 |
|------|------|
| **TR CD** | `t0424` |
| **메서드** | `jango2()` |
| **용도** | 보유 종목 및 평가 손익 조회 |
| **요청** | `prcgb`: 단가구분, `chegb`: 체결구분, `dangb`: 단일가구분, `charge`: 제비용포함 |
| **응답** | 추정순자산, 실현손익, 평가금액, 평가손익, 종목별 잔고 (잔고수량, 매도가능수량, 평균단가, 매입금액, 평가금액, 손익, 수익률) |

#### 4.5 BEP 단가 조회
| 항목 | 내용 |
|------|------|
| **TR CD** | `CSPAQ12300` |
| **메서드** | `bep_danga()` |
| **용도** | Break-Even Point 단가 조회 |
| **요청** | - `BalCreTp`: 잔고생성구분 ("0"=전체, "1"=현물, "9"=선물대용)<br>- `CmsnAppTpCode`: 수수료적용여부<br>- `UprcTpCode`: 단가구분 ("0"=평균단가, "1"=BEP단가) |
| **응답** | 예수금, 대용금, 증거금, 주문가능금액, 잔고평가금액, 손익률, 종목별 상세 (약 60개 필드) |

#### 4.6 주문가능금액 조회
| 항목 | 내용 |
|------|------|
| **TR CD** | `CSPAQ22200` |
| **메서드** | `order_possible_money()` |
| **용도** | 주문 가능한 현금/대용 금액 조회 |
| **요청** | `BalCreTp`: 잔고생성구분 (기본: "0") |
| **응답** | 지점명, 계좌명, 현금주문가능금액, 대용주문가능금액, 거래소/코스닥 금액, 예수금, 미수금, D1/D2 예수금 |

---

## WebSocket API (실시간 데이터)

### 연결 정보

| 항목 | 내용 |
|------|------|
| **URL** | `wss://openapi.ls-sec.co.kr:9443/websocket` |
| **인증** | Access Token 기반 (12시간 유효) |

### 실시간 TR ID 목록

| TR CD | 이름 | TR Key | 용도 |
|-------|------|--------|------|
| `NWS` | 뉴스 | `NWS001` | 뉴스 데이터 실시간 수신 |
| `SC1` | 주식주문체결 | (빈값) | 주문 접수/체결/정정/취소 실시간 통보 |
| `SC0` | 주식주문접수 | - | 주문이 접수되었음을 알리는 통보 |

### WebSocket 구독 타입

| 타입 | 설명 |
|------|------|
| 1 | 주식주문체결(SC1) 구독 |
| 2 | 주식주문체결(SC1) 구독해제 |
| 3 | 뉴스(NWS) 구독 |
| 4 | 뉴스(NWS) 구독해제 |

### WebSocket 요청 구조

```json
{
    "header": {
        "token": "<ACCESS_TOKEN>",
        "tr_type": "<TYPE>"
    },
    "body": {
        "tr_cd": "<TR_CD>",
        "tr_key": "<TR_KEY>"
    }
}
```

### WebSocket 응답 데이터

#### 뉴스 (NWS)
- `date`, `code`, `realkey`, `bodysize`, `time`, `id`, `title`

#### 주식주문체결 (SC1)
약 130개 필드 포함:
- `ordno`: 주문번호
- `execno`: 체결번호
- `shtnIsuno`: 단축종목번호 (예: "A005930")
- `Isunm`: 종목명
- `execqty`: 체결수량
- `execprc`: 체결가격
- `ordamt`: 주문금액
- `bnstp`: 매매구분 ("1"=매도, "2"=매수)
- `deposit`: 예수금
- `substamt`: 대용금
- `ordablemny`: 주문가능현금

---

## API 요약

### 용도별 분류

| 분류 | 개수 | 주요 TR CD |
|------|------|------------|
| 시세 조회 | 3개 | t1102, t8407, t9945 |
| 상위종목 순위 | 8개 | t1441~t1492 |
| 주문 | 3개 | CSPAT00601, CSPAT00701, CSPAT00801 |
| 계좌 조회 | 6개 | CDPCQ04700, t0424, t0425, CSPAQ12300, CSPAQ13700, CSPAQ22200 |
| WebSocket | 2개 | NWS, SC1 |
| **총합** | **22개** | - |

### API 경로별 분류

| 경로 | 개수 | 용도 |
|------|------|------|
| `/stock/market-data` | 11개 | 시세 조회 (현재가, 마스터, 상위종목) |
| `/stock/order` | 3개 | 주문 (신규, 정정, 취소) |
| `/stock/accno` | 6개 | 계좌 조회 (거래내역, 체결, 잔고) |
| WebSocket | 2개 | 실시간 데이터 (뉴스, 주문체결) |

---

## 주요 코드/제약사항

### 매매구분 코드 (BnsTpCode)
| 코드 | 설명 |
|------|------|
| 1 | 매도 |
| 2 | 매수 |

### 시장구분 코드 (gubun1)
| 코드 | 설명 |
|------|------|
| 0 | 전체 |
| 1 | 코스피 |
| 2 | 코스닥 |

### 종목대분류 코드 (IsuLgclssCode)
| 코드 | 설명 |
|------|------|
| 01 | 주식 |
| 02 | 채권 |
| 03 | 선물 |
| 04 | 펀드 |
| 05 | 해외주식 |
| 06 | 해외파생 |

### 토큰 관련
- **유효기간**: 12시간
- **자동 갱신**: StockApiManager에서 자동 체크 및 갱신

### 연속 조회
- `tr_cont` / `tr_cont_key` 파라미터로 페이징 지원
- 대량 데이터 조회 시 연속 조회 필요

### 종목번호 형식
- **주식**: 종목코드 또는 A+종목코드 (예: "005930" 또는 "A005930")
- **ELW**: J+종목코드
- **ETN**: Q+종목코드
