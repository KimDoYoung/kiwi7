# 설계

## 고려할 점

- TODO /mystock/prices table mystock에 있는 종목의 현재가격을 리턴한다.
- TODO 테이블 mystock: stk_cd, stk_nm, 보유, 관심,status(active, inactive), note
- TODO stock_history 테이블: stk_cd, stk_nm, date(ymd), buy_or_sell, price, note
- TODO 영웅문에서 조건식을 만들고 그것으로 검색
- TODO 영웅문에서 관심종목을 넣고 조회
- TODO 매수 - 현재 가용금액으로 살 수 있는 최대 갯수
- TODO 매도 - 현재 가격에서 2%, 3%, 5% 7% 10% 금액
- TODO detail stk_cd에 대한 모든 것.... 2개의 api, 그리고 내가 보유하고 있는지여부, 언제 팔고 언제 샀는지 여부,
- TODO AI를 붙이자, 현재 나의 계좌를 보면서 대화, 주식 시장 전반에 대한 의견을 나눔, 
- TODO 주달로 데이터를 주집, stk_info 테이블에 넣어두기
- TODO 미체결 리스트, 체결리스트
- TODO 환율정보 가져오기
- TODO 종목토론정보 가져오기
- TODO scheduler가 있어야한다. kdemon과는 달리 kscheduler를 갖고 있어야함. scheduler에 걸리는 task job은 모두 async로
- TODO main에서 기록 계속 올라가고 있는지 떨어지고 있는지 변동성 큰지?
- TODO 챠트를 만들자 stock/detail에


- kdemon :  table rule에 따라서 알아서 동작한다.
- OpentimeChecker : 오늘, 시각에 따라서 현재 어떤 시장을 선택할 지 알려준다. KRX,NXT,None 

## kscheduler

KScheduler = time-based orchestration
interval·cron(간단형)·once(at) 실행 지원
모든 잡은 async 함수여야 함 (await 가능)

- 영속성
    SQLite에 잡 정의/실행 이력 저장 → 재시작해도 일정 유지

- 동시성 & 중복방지
    잡별 max_concurrency, overlap_policy(skip/queue/cancel) 지원
    멀티 프로세스라도 같은 DB를 공유하면 락 테이블로 중복 실행 방지(옵션)

- 안전장치
    타임아웃, 재시도(지수 백오프), 지터(jitter) 옵션
    Graceful shutdown 지원(현재 실행중인 잡에 cancel 신호)

- 트레이딩 시간과의 공존
    잡 정의에서 gating 콜백을 주면, 장이 열리는 시간에도/아니어도 돌릴지 제어 가능
    (예: “장 열릴 땐 저부하 작업만”, “01:00 스크래핑은 무조건 실행” 등)

## kdemon

```text
데몬 성격의 모듈을 붙일 수 있을까? 예를 들어 kdemon 이라고 부르자. 사용자가 api를 호출하면 ㅏtable에 저장을 하고 kdemon에 command `refresh'를 보내면 table에 저장된 명령어들을 다시 loading, `stop`을 보내면 kdemon stop,  start... 이렇게 kdemon.에 명령얼 보내는 식으로 하면 좋을 듯. kdemon은 등록된 명령에 따라서 즉 a종목이 100원이상이면 10주를 매도해라 이런 것을 자동으로 하는 것이지. 물론 주어진 시간마다 현재가를 가져와서 해당하는 명령이 있는지 체크하고
```
1. sqls/kii7_ddl.sql 에 관련 테이블 생성 DDL


## OpentimeChecker

- singleton
- public mehtod getMarket : 
  - 오늘이 휴장일인가?
  - 지금 시각이 KRX가능시간인가? 만약 그렇다면 KRX, 
  - 지금 시각이 NXT? 그렇다면 NXT
  - 아니면 None
- isHoliday
- isKrxTime
- isNxtTime
- 공공데이터의 이용
- isHoliday 로직
  1. memory에 오늘이 holiday인지 값이 있으면 true
  2. cache의 값이 오늘이 아니면 체크시작
  3. 오늘이 토,일인제 체크, 토일이면  true
  4. 오늘의 year,  month로 GODATA를 가져와서 오늘이 리스트에 있으면 true
  5. 각 단계마다. cache를 비우고 값을 채운다.
- 증시가 열리는 날이면서 오전 9:00-15:30 은 KRX
- 15:30~20:00, 08:00~08:50 NXT 리턴

### 사용법
```python
    checker = OpenTimeChecker.get()
    now = datetime.now(tz=ZoneInfo(config.TIME_ZONE))
    market = await checker.getMarket(now)
    # market이 None이면 장마감 상태
```

## mystock
- main화면에 주기적으로 표시할 내용
- ddl
  ```sql
CREATE TABLE IF NOT EXISTS mystock (
  stk_cd     TEXT    NOT NULL,                               -- 종목코드 (PK)
  stk_nm     TEXT    NOT NULL,                               -- 종목명
  is_hold    INTEGER NOT NULL DEFAULT 0                      -- 보유여부 (0/1)
             CHECK (is_hold IN (0,1)),
  is_watch   INTEGER NOT NULL DEFAULT 0                      -- 관심여부 (0/1)
             CHECK (is_watch IN (0,1)),
  note       TEXT,                                           -- 메모
  created_at TEXT    NOT NULL DEFAULT (strftime('%Y-%m-%d %H:%M:%S','now','localtime')),
  updated_at TEXT    NOT NULL DEFAULT (strftime('%Y-%m-%d %H:%M:%S','now','localtime')),
  PRIMARY KEY (stk_cd)
);  
  ```
