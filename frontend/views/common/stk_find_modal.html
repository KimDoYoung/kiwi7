<!-- 종목 찾기 모달 -->
<dialog id="stkFindModal" class="modal" x-data="stk_find_modal()">
    <div class="modal-box w-11/12 max-w-3xl h-[600px] flex flex-col">
        <!-- Header -->
        <div class="flex justify-between items-center mb-4 pb-2 border-b border-base-200">
            <h3 class="font-bold text-lg flex items-center gap-2">
                <i class="bi bi-search text-primary"></i> 종목 찾기
            </h3>
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost">✕</button>
            </form>
        </div>

        <!-- Body (Flex Grow to fill space) -->
        <div class="flex-grow flex flex-col overflow-hidden">
            <!-- 검색 영역 -->
            <form @submit.prevent="searchStock" class="mb-4">
                <div class="flex flex-col md:flex-row gap-3">
                    <div class="flex-grow">
                        <input type="text" class="input input-bordered w-full" id="stkFindInput"
                            placeholder="종목명/코드 입력 (예: 삼성전자)" x-model="keyword" autofocus required>
                    </div>
                    <div class="w-full md:w-32">
                        <select class="select select-bordered w-full" x-model="limit">
                            <option value="10">10개</option>
                            <option value="20" selected>20개</option>
                            <option value="50">50개</option>
                        </select>
                    </div>
                    <div class="w-full md:w-24">
                        <button type="submit" class="btn btn-primary w-full" :disabled="loading || !keyword.trim()">
                            <span x-show="loading" class="loading loading-spinner loading-xs"></span>
                            <i x-show="!loading" class="bi bi-search"></i>
                            <span class="hidden md:inline" x-text="loading ? '' : '검색'"></span>
                        </button>
                    </div>
                </div>
            </form>

            <!-- 메시지 영역 -->
            <div x-show="msg" class="alert mb-4 py-2 text-sm"
                :class="msgType === 'error' ? 'alert-error' : 'alert-info'" role="alert">
                <i :class="msgType === 'error' ? 'bi bi-exclamation-triangle' : 'bi bi-info-circle'"></i>
                <span x-text="msg"></span>
            </div>

            <!-- 로딩 상태 -->
            <div x-show="loading" class="flex flex-col items-center justify-center flex-grow">
                <span class="loading loading-spinner loading-lg text-primary"></span>
                <p class="mt-2 text-base-content/60">검색 중입니다...</p>
            </div>

            <!-- 검색 결과 (Fixed Header Table with Scrollable Body) -->
            <div x-show="!loading && results.length > 0"
                class="flex-grow overflow-auto border border-base-200 rounded-lg">
                <table class="table table-pin-rows w-full">
                    <thead>
                        <tr>
                            <th>종목코드</th>
                            <th>종목명</th>
                            <th>시장</th>
                            <th class="text-center">추가</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="(item, index) in results" :key="item.code || index">
                            <tr class="hover">
                                <td class="font-mono font-bold" x-text="item.code || '-'"></td>
                                <td x-text="item.name || '-'"></td>
                                <td>
                                    <div class="badge badge-sm" :class="getMarketBadgeClass(item.market_name)"
                                        x-text="item.market_name || '-'"></div>
                                </td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-square btn-success btn-outline"
                                        @click="addToMyStock(item)" :disabled="!item.code" title="My Stock에 추가">
                                        <i class="bi bi-plus text-lg"></i>
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- 결과 없음 -->
            <div x-show="!loading && results.length === 0 && keyword && searched"
                class="flex flex-col items-center justify-center flex-grow text-base-content/50">
                <i class="bi bi-inbox text-5xl mb-2"></i>
                <p>검색 결과가 없습니다.</p>
            </div>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
    // 종목 찾기 모달 Alpine.js 컴포넌트
    function stk_find_modal() {
        return {
            loading: false,
            msg: null,
            msgType: 'info',
            keyword: '',
            limit: 20,
            results: [],
            searched: false,

            init() {
                // Bootstrap listener removed.
                // HTML5 autofocus attribute handles focus on open.
            },

            async searchStock() {
                if (!this.keyword.trim()) {
                    this.showMessage('검색어를 입력해주세요.', 'error');
                    return;
                }

                this.loading = true;
                this.msg = null;
                this.results = [];
                this.searched = false;

                try {
                    // Mock Fetch for demo if fetch-util not present, but it should be.
                    // Assuming postFetch is globally available.
                    const response = await postFetch('/api/v1/stock/find', {
                        api_id: "stock_find",
                        payload: {
                            keyword: this.keyword.trim(),
                            limit: parseInt(this.limit)
                        }
                    });

                    if (response.success) {
                        this.results = response.data?.results || [];
                        this.searched = true;

                        if (this.results.length === 0) {
                            this.showMessage(`'${this.keyword}' 검색 결과가 없습니다.`, 'info');
                        } else {
                            // this.showMessage(`검색 결과 ${this.results.length}건을 찾았습니다.`, 'info');
                        }
                    } else {
                        this.showMessage(response.error_message || '검색 중 오류가 발생했습니다.', 'error');
                    }

                } catch (error) {
                    console.error('검색 오류:', error);
                    this.showMessage('검색 중 오류가 발생했습니다: ' + error.message, 'error');
                } finally {
                    this.loading = false;
                }
            },

            async addToMyStock(item) {
                if (!item.code) {
                    this.showMessage('종목코드가 없습니다.', 'error');
                    return;
                }

                try {
                    const response = await putFetch('/api/v1/mystock/' + item.code);

                    if (response.success) {
                        this.showMessage(`'${item.name}' 종목이 My Stock에 추가되었습니다.`, 'success');
                        // Refresh Main MyStock List if main_data exists
                        if (typeof main_data === 'function') {
                            // This is tricky structurally. 
                            // Better to reload page or use event bus. 
                            // For now just alert success.
                        }
                        if (typeof showAlert === 'function') {
                            showAlert(`'${item.name}' 종목이 My Stock에 추가되었습니다.`, 'success');
                        }
                        // Emit event for main page to listen
                        window.dispatchEvent(new CustomEvent('mystock-updated'));

                    } else {
                        this.showMessage(response.error_message || 'My Stock 추가 중 오류가 발생했습니다.', 'error');
                    }

                } catch (error) {
                    console.error('My Stock 추가 오류:', error);
                    this.showMessage('My Stock 추가 중 오류가 발생했습니다: ' + error.message, 'error');
                }
            },

            showMessage(message, type = 'info') {
                this.msg = message;
                this.msgType = type;

                setTimeout(() => {
                    this.msg = null;
                }, 3000);
            },

            getMarketBadgeClass(marketName) {
                if (!marketName) return 'badge-ghost';

                const market = marketName.toLowerCase();
                if (market.includes('코스피')) return 'badge-primary badge-outline';
                if (market.includes('코스닥')) return 'badge-success badge-outline';
                if (market.includes('etf')) return 'badge-warning badge-outline';
                return 'badge-info badge-outline';
            },

            resetModal() {
                this.keyword = '';
                this.results = [];
                this.msg = null;
                this.searched = false;
                this.loading = false;
            }
        }
    }
</script>