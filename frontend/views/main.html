{% extends "common/base.html" %}

{% block content %}
<div x-data="main_data()" class="container mt-4">
    <!-- 지수 정보 카드 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <!-- card-header 부분 수정 -->
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up me-2"></i><span x-text="market_name"></span>
                    </h5>
                    <div class="d-flex align-items-center gap-3">
                        <!-- 자동 새로고침 스위치 -->
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoRefreshSwitch" 
                                x-model="autoRefresh" @change="toggleAutoRefresh()">
                            <label class="form-check-label" for="autoRefreshSwitch">
                                자동
                            </label>
                        </div>
                        
                        <!-- 새로고침 버튼 -->
                        <button @click="refreshJisu()" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-arrow-clockwise" :style="loading ? 'animation: spin 1s linear infinite;' : ''"></i>
                            새로고침
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 로딩 상태 -->
                    <div x-show="loading" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">지수 정보를 불러오는 중...</p>
                    </div>

                    <!-- 지수 정보 표시 -->
                    <div x-show="!loading" class="row g-3">
                        <!-- KOSPI -->
                        <div class="col-md-4">
                            <div class="border rounded p-3 h-100">
                                <div class="text-center">
                                    <h6 class="text-muted fw-bold mb-2">KOSPI</h6>
                                    <div class="fs-3 fw-bold mb-1" 
                                         :class="getIndexColorClass(jisu.KOSPI?.rate)"
                                         x-text="formatIndex(jisu.KOSPI?.index)">
                                        -
                                    </div>
                                    <div class="d-flex justify-content-center align-items-center">
                                        <span class="me-2"
                                              :class="getIndexColorClass(jisu.KOSPI?.rate)"
                                              x-text="formatDiff(jisu.KOSPI?.diff, jisu.KOSPI?.rate)">
                                            -
                                        </span>
                                        <span :class="getIndexColorClass(jisu.KOSPI?.rate)"
                                              x-text="(jisu.KOSPI?.rate || '-') + '%'">
                                            -
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- KOSDAQ -->
                        <div class="col-md-4">
                            <div class="border rounded p-3 h-100">
                                <div class="text-center">
                                    <h6 class="text-muted fw-bold mb-2">KOSDAQ</h6>
                                    <div class="fs-3 fw-bold mb-1"
                                         :class="getIndexColorClass(jisu.KOSDAQ?.rate)"
                                         x-text="formatIndex(jisu.KOSDAQ?.index)">
                                        -
                                    </div>
                                    <div class="d-flex justify-content-center align-items-center">
                                        <span class="me-2"
                                              :class="getIndexColorClass(jisu.KOSDAQ?.rate)"
                                              x-text="formatDiff(jisu.KOSDAQ?.diff, jisu.KOSDAQ?.rate)">
                                            -
                                        </span>
                                        <span :class="getIndexColorClass(jisu.KOSDAQ?.rate)"
                                              x-text="(jisu.KOSDAQ?.rate || '-') + '%'">
                                            -
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- KOSPI200 -->
                        <div class="col-md-4">
                            <div class="border rounded p-3 h-100">
                                <div class="text-center">
                                    <h6 class="text-muted fw-bold mb-2">KOSPI200</h6>
                                    <div class="fs-3 fw-bold mb-1"
                                         :class="getIndexColorClass(jisu.KOSPI200?.rate)"
                                         x-text="formatIndex(jisu.KOSPI200?.index)">
                                        -
                                    </div>
                                    <div class="d-flex justify-content-center align-items-center">
                                        <span class="me-2"
                                              :class="getIndexColorClass(jisu.KOSPI200?.rate)"
                                              x-text="formatDiff(jisu.KOSPI200?.diff, jisu.KOSPI200?.rate)">
                                            -
                                        </span>
                                        <span :class="getIndexColorClass(jisu.KOSPI200?.rate)"
                                              x-text="(jisu.KOSPI200?.rate || '-') + '%'">
                                            -
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 오류 메시지 -->
                    <div x-show="error" class="alert alert-danger mt-3">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <span x-text="error"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
    
{% endblock %}

{% block script %}
<script>
  function main_data() {
    return {
      jisu: {},
      market_name: '',
      loading: false,
      error: null,
      autoRefresh: false,        // 자동 새로고침 상태
      autoRefreshInterval: null, // 자동 새로고침 인터벌 ID
      refreshIntervalSeconds: 30, // 30초마다 새로고침

      async init() {
        // 페이지 로드 시 지수 정보 가져오기
        await this.refreshJisu();
      },
      // 자동 새로고침 토글
      toggleAutoRefresh() {
        if (this.autoRefresh) {
          // 자동 새로고침 시작
          this.startAutoRefresh();
          console.log('자동 새로고침 시작 (30초 간격)');
        } else {
          // 자동 새로고침 중지
          this.stopAutoRefresh();
          console.log('자동 새로고침 중지');
        }
      },      
      // 자동 새로고침 시작
      startAutoRefresh() {
        // 기존 인터벌이 있다면 정리
        this.stopAutoRefresh();
        
        // 새로운 인터벌 설정 (30초마다)
        this.autoRefreshInterval = setInterval(async () => {
          if (this.autoRefresh && !this.loading) {
            console.log('자동 새로고침 실행...');
            await this.refreshJisu();
          }
        }, this.refreshIntervalSeconds * 1000);
      },

      // 자동 새로고침 중지
      stopAutoRefresh() {
        if (this.autoRefreshInterval) {
          clearInterval(this.autoRefreshInterval);
          this.autoRefreshInterval = null;
        }
      },
      async refreshJisu() {
        this.loading = true;
        this.error = null;
        
        try {
          // 실제 API 호출
          const response = await fetch('/api/v1/kiwoom/jisu');
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          
          // 성공 응답인지 확인
          if (data.success === false) {
            throw new Error(data.error_message || '지수 정보를 불러오는데 실패했습니다.');
          }
          
          this.jisu = data;
          console.info(this.jisu)
          let market = this.jisu.market
          if (market == 'KRX'){
            this.market_name = '한국거래소(KRX)'
          }else if (market == 'NXT'){
            this.market_name = '넥스트레이드(NXT)'
          }else{
            this.market_name = "장마감"
            this.stopAutoRefresh()
          }
        } catch (error) {
          console.error('지수 정보 조회 실패:', error);
          this.error = error.message || '지수 정보를 불러오는데 실패했습니다. 잠시 후 다시 시도해주세요.';
          
          // 오류 발생 시 임시 데이터 표시 (개발용)
          this.jisu = {
            'KOSPI': {'index': 'N/A', 'diff': 'N/A', 'rate': 'N/A'},
            'KOSDAQ': {'index': 'N/A', 'diff': 'N/A', 'rate': 'N/A'},
            'KOSPI200': {'index': 'N/A', 'diff': 'N/A', 'rate': 'N/A'}
          };
        } finally {
          this.loading = false;
        }
      },

      // 지수 값 포맷 (콤마 추가)
      formatIndex(value) {
        if (!value) return '-';
        return value; // 이미 콤마가 포함된 문자열
      },

      // 등락폭 포맷 (+/- 기호 추가)
      formatDiff(diff, rate) {
        if (!diff) return '-';
        const numDiff = parseFloat(diff);
        if (rate > 0) {
            return `▲${diff}`;
        }else{
            return `▼${diff}`;
        }
        return diff;
      },

      // 등락에 따른 색상 클래스 반환
      getIndexColorClass(diff) {
        if (!diff) return 'text-muted';
        const numDiff = parseFloat(diff);
        if (numDiff > 0) {
          return 'text-danger'; // 상승 - 빨간색
        } else if (numDiff < 0) {
          return 'text-primary'; // 하락 - 파란색
        }
        return 'text-muted'; // 보합 - 회색
      }
    };
  }
</script>

{% endblock %}
