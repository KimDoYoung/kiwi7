{% extends "common/base.html" %}

{% block content %}
<div x-data="main_data()" class="container mt-4">
    <!-- 지수 정보 카드 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>주요 지수
                    </h5>
                    <button @click="refreshJisu()" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-sync-alt" :class="{ 'fa-spin': loading }"></i>
                        새로고침
                    </button>
                </div>
                <div class="card-body">
                    <!-- 로딩 상태 -->
                    <div x-show="loading" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">지수 정보를 불러오는 중...</p>
                    </div>

                    <!-- 지수 정보 표시 -->
                    <div x-show="!loading" class="row g-3">
                        <!-- KOSPI -->
                        <div class="col-md-4">
                            <div class="border rounded p-3 h-100">
                                <div class="text-center">
                                    <h6 class="text-muted fw-bold mb-2">KOSPI</h6>
                                    <div class="fs-3 fw-bold mb-1" 
                                         :class="getIndexColorClass(jisu.KOSPI?.diff)"
                                         x-text="formatIndex(jisu.KOSPI?.index)">
                                        -
                                    </div>
                                    <div class="d-flex justify-content-center align-items-center">
                                        <span class="me-2"
                                              :class="getIndexColorClass(jisu.KOSPI?.diff)"
                                              x-text="formatDiff(jisu.KOSPI?.diff)">
                                            -
                                        </span>
                                        <span :class="getIndexColorClass(jisu.KOSPI?.diff)"
                                              x-text="jisu.KOSPI?.rate || '-'">
                                            -
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- KOSDAQ -->
                        <div class="col-md-4">
                            <div class="border rounded p-3 h-100">
                                <div class="text-center">
                                    <h6 class="text-muted fw-bold mb-2">KOSDAQ</h6>
                                    <div class="fs-3 fw-bold mb-1"
                                         :class="getIndexColorClass(jisu.KOSDAQ?.diff)"
                                         x-text="formatIndex(jisu.KOSDAQ?.index)">
                                        -
                                    </div>
                                    <div class="d-flex justify-content-center align-items-center">
                                        <span class="me-2"
                                              :class="getIndexColorClass(jisu.KOSDAQ?.diff)"
                                              x-text="formatDiff(jisu.KOSDAQ?.diff)">
                                            -
                                        </span>
                                        <span :class="getIndexColorClass(jisu.KOSDAQ?.diff)"
                                              x-text="jisu.KOSDAQ?.rate || '-'">
                                            -
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- KOSPI200 -->
                        <div class="col-md-4">
                            <div class="border rounded p-3 h-100">
                                <div class="text-center">
                                    <h6 class="text-muted fw-bold mb-2">KOSPI200</h6>
                                    <div class="fs-3 fw-bold mb-1"
                                         :class="getIndexColorClass(jisu.KOSPI200?.diff)"
                                         x-text="formatIndex(jisu.KOSPI200?.index)">
                                        -
                                    </div>
                                    <div class="d-flex justify-content-center align-items-center">
                                        <span class="me-2"
                                              :class="getIndexColorClass(jisu.KOSPI200?.diff)"
                                              x-text="formatDiff(jisu.KOSPI200?.diff)">
                                            -
                                        </span>
                                        <span :class="getIndexColorClass(jisu.KOSPI200?.diff)"
                                              x-text="jisu.KOSPI200?.rate || '-'">
                                            -
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 오류 메시지 -->
                    <div x-show="error" class="alert alert-danger mt-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span x-text="error"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
  function main_data() {
    return {
      jisu: {},
      loading: false,
      error: null,

      async init() {
        // 페이지 로드 시 지수 정보 가져오기
        await this.refreshJisu();
      },

      async refreshJisu() {
        this.loading = true;
        this.error = null;
        
        try {
          // 실제 API 호출
          const response = await fetch('/api/v1/kiwoom/jisu');
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          
          // 성공 응답인지 확인
          if (data.success === false) {
            throw new Error(data.error_message || '지수 정보를 불러오는데 실패했습니다.');
          }
          
          this.jisu = data;
          
        } catch (error) {
          console.error('지수 정보 조회 실패:', error);
          this.error = error.message || '지수 정보를 불러오는데 실패했습니다. 잠시 후 다시 시도해주세요.';
          
          // 오류 발생 시 임시 데이터 표시 (개발용)
          this.jisu = {
            'KOSPI': {'index': 'N/A', 'diff': 'N/A', 'rate': 'N/A'},
            'KOSDAQ': {'index': 'N/A', 'diff': 'N/A', 'rate': 'N/A'},
            'KOSPI200': {'index': 'N/A', 'diff': 'N/A', 'rate': 'N/A'}
          };
        } finally {
          this.loading = false;
        }
      },

      // 지수 값 포맷 (콤마 추가)
      formatIndex(value) {
        if (!value) return '-';
        return value; // 이미 콤마가 포함된 문자열
      },

      // 등락폭 포맷 (+/- 기호 추가)
      formatDiff(diff) {
        if (!diff) return '-';
        const numDiff = parseFloat(diff);
        if (numDiff > 0) {
          return `+${diff}`;
        }
        return diff;
      },

      // 등락에 따른 색상 클래스 반환
      getIndexColorClass(diff) {
        if (!diff) return 'text-muted';
        const numDiff = parseFloat(diff);
        if (numDiff > 0) {
          return 'text-danger'; // 상승 - 빨간색
        } else if (numDiff < 0) {
          return 'text-primary'; // 하락 - 파란색
        }
        return 'text-muted'; // 보합 - 회색
      }
    };
  }
</script>
    
{% endblock %}

{% block script %}
<!-- <script src="/public/js/fetch-util.js"></script> -->
{% endblock %}
