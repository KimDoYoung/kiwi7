{% extends 'common/base.html' %}
{% block style %}
<style>
    .table-vcenter td {
        vertical-align: middle !important;
    }
</style>
{% endblock %}
{% block content %}
<div x-data="stock_find" class="container mt-4">
    <div class="search-area">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-search me-2"></i>종목 검색</h5>
            </div>
            <div class="card-body">
                <form @submit.prevent="submit" class="mb-4">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label for="keyword" class="form-label">종목명 또는 종목코드</label>
                            <input type="text" 
                                   class="form-control form-control-lg" 
                                   id="keyword" 
                                   name="keyword" 
                                   placeholder="예: 삼성전자, 005930" 
                                   x-model="keyword"
                                   required>
                        </div>
                        <div class="col-md-2">
                            <label for="limit" class="form-label">결과 제한</label>
                            <select class="form-select" id="limit" x-model="limit">
                                <option value="10">10개</option>
                                <option value="20">20개</option>
                                <option value="50">50개</option>
                                <option value="100">100개</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" 
                                    class="btn btn-primary btn-lg w-100" 
                                    :disabled="loading || !keyword.trim()">
                                <span x-show="loading" class="spinner-border spinner-border-sm me-2" role="status"></span>
                                <i x-show="!loading" class="bi bi-search me-1"></i>
                                <span x-text="loading ? '검색중...' : '검색'"></span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="mt-4 result-area">
        <template x-if="msg">
            <div class="alert" :class="msgType === 'error' ? 'alert-danger' : 'alert-info'" role="alert">
                <i :class="msgType === 'error' ? 'bi bi-exclamation-triangle' : 'bi bi-info-circle'" class="me-2"></i>
                <span x-text="msg"></span>
            </div>
        </template>
        
        <template x-if="data.length > 0">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-list me-2"></i>
                        검색 결과: <span x-text="data.length"></span>개
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-vcenter mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="text-center" style="width: 50px;">No</th> 
                                    <th style="width: 80px;">종목코드</th>
                                    <th style="width: 120px;">종목명</th>
                                    <th style="width: 80px;">시장명</th>
                                    <th class="text-end" style="width: 100px;">업종명</th>
                                    <th class="text-end" style="width: 90px;">상장주식수</th>
                                    <th class="text-center" style="width: 80px;">상장일</th>
                                    <th class="text-end" style="width: 80px;">전일종가</th>
                                    <th class="text-center" style="width: 70px;">NXT가능</th>
                                    <th class="text-center" style="width: 60px;">상세정보</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(item, index) in data" :key="item.code || index">
                                    <tr>
                                        <td class="text-center" x-text="index + 1"></td>
                                        <td>
                                            <a href="javascript:void(0);" 
                                               @click="goNaver(item.code)" 
                                               class="text-decoration-none fw-bold"
                                               x-text="item.code || '-'"></a>
                                        </td>
                                        <td>
                                            <a href="javascript:void(0);" 
                                               @click="showDetail(item)" 
                                               class="text-decoration-none"
                                               x-text="item.name || '-'"></a>
                                        </td>
                                        <td>
                                            <span class="badge" 
                                                  :class="getBadgeClass(item.market_name)"
                                                  x-text="item.market_name || '-'"></span>
                                        </td>
                                        <td class="text-end" x-text="item.up_name || '-'"></td>
                                        <td class="text-end" x-text="item.list_count ? Number(item.list_count).toLocaleString() : '-'"></td>
                                        <td class="text-center" x-text="formatDate(item.reg_day)"></td>
                                        <td class="text-end" x-text="item.last_price ? Number(item.last_price).toLocaleString() : '-'"></td>
                                        <td class="text-center">
                                            <span class="badge" 
                                                  :class="item.nxt_enable === 'Y' ? 'bg-success' : 'bg-secondary'"
                                                  x-text="item.nxt_enable || '-'"></span>
                                        </td>
                                        <td class="text-center">
                                            <button class="btn btn-outline-primary btn-sm" 
                                                    @click="showDetail(item)"
                                                    :disabled="!item.code"
                                                    title="상세정보 보기"
                                                    style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;">
                                                <i class="bi bi-info-circle"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </template>
        
        <template x-if="loading">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">검색 중입니다...</p>
            </div>
        </template>
    </div>
</div>
{% raw %}
<!--handlebar scripts-->
{% endraw %}
{% endblock %}
{% block script %}
<!-- <script src="/public/js/fetch-util.js"></script> -->
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('stock_find', () => {
        return {
            loading: false,
            msg: null,
            msgType: 'info', // 'info' or 'error'
            keyword: '',
            limit: 20,
            data: [],
            
            init() {
                console.log('stock_find 초기화 완료');
            },
            
            async submit() {
                if (!this.keyword.trim()) {
                    this.showMessage('검색어를 입력해주세요.', 'error');
                    return;
                }
                
                this.msg = null;
                this.data = [];
                this.loading = true;
                
                try {
                    console.log('종목 검색 시작:', { keyword: this.keyword, limit: this.limit });
                    
                    // KiwoomRequest 형식으로 변경
                    const response = await postFetch('/api/v1/stock/find', {
                        api_id: "stock_find",
                        payload: {
                            keyword: this.keyword.trim(),
                            limit: parseInt(this.limit)
                        }
                    });
                    
                    console.log('검색 응답:', response);
                    
                    if (response.success) {
                        this.data = response.data?.results || [];
                        
                        if (this.data.length === 0) {
                            this.showMessage(`'${this.keyword}' 검색 결과가 없습니다.`, 'info');
                        } else {
                            this.showMessage(response.data?.message || `검색 결과 ${this.data.length}건을 찾았습니다.`, 'info');
                        }
                    } else {
                        this.showMessage(response.error_message || '검색 중 오류가 발생했습니다.', 'error');
                    }
                    
                } catch (error) {
                    console.error('검색 오류:', error);
                    this.showMessage('검색 중 오류가 발생했습니다: ' + error.message, 'error');
                } finally {
                    this.loading = false;
                }
            },
            
            showMessage(message, type = 'info') {
                this.msg = message;
                this.msgType = type;
                
                // 3초 후 메시지 자동 사라짐
                setTimeout(() => {
                    this.msg = null;
                }, 3000);
            },
            
            getBadgeClass(marketName) {
                if (!marketName) return 'bg-secondary';
                
                const market = marketName.toLowerCase();
                if (market.includes('코스피')) return 'bg-primary';
                if (market.includes('코스닥')) return 'bg-success';
                if (market.includes('etf')) return 'bg-warning text-dark';
                return 'bg-info text-dark';
            },
            
            formatDate(dateStr) {
                if (!dateStr || dateStr.length !== 8) return '-';
                
                // YYYYMMDD -> YYYY-MM-DD 형태로 변환
                return `${dateStr.slice(0,4)}-${dateStr.slice(4,6)}-${dateStr.slice(6,8)}`;
            },
            
            showDetail(item) {
                if (!item.code) {
                    this.showMessage('종목코드가 없습니다.', 'error');
                    return;
                }
                
                console.log('상세 정보:', item);
                // 기존 showCompanyCanvas 함수 사용
                if (typeof showCompanyCanvas === 'function') {
                    showCompanyCanvas(item.code);
                } else {
                    console.warn('showCompanyCanvas 함수를 찾을 수 없습니다.');
                    this.goNaver(item.code);
                }
            },
            
            goNaver(stk_code) {
                if (!stk_code) {
                    this.showMessage('종목코드가 없습니다.', 'error');
                    return;
                }
                
                const url = `https://finance.naver.com/item/main.naver?code=${stk_code}`;
                window.open(url, '_blank');
            }
        }
    });
});
</script>
{% endblock %}
