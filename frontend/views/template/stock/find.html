{% extends 'common/base.html' %}
{% block style %}
{% endblock %}
{% block content %}
<div x-data="stock_find" class="container mt-4">
    <div class="search-area">
  <h4>종목명으로 검색</h4>
  <form @submit.prevent="submit" class="mb-4">
    <div class="row g-3">
      <div class="col-md-4">
        <label for="apiId" class="form-label">시장구분</label>
        <div class="d-flex gap-3">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="kospi" value="0" x-model="mrkt_tp_kospi">
            <label class="form-check-label" for="kospi">코스피</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="kosdaq" value="10" x-model="mrkt_tp_kosdaq">
            <label class="form-check-label" for="kosdaq">코스닥</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="etf" value="30" x-model="mrkt_tp_etf">
            <label class="form-check-label" for="etf">ETF</label>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <label for="stkCode" class="form-label">종목명</label>
        <input type="text" class="form-control" id="keyword" name="keyword" placeholder="종목명" x-model="keyword">
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary" :disabled="loading">
          <span x-show="loading" class="spinner-border spinner-border-sm me-2" role="status"></span>
          조회
        </button>
      </div>
    </div>
  </form>
    </div>
    <div class="mt-4 result-area">
        <template x-if="msg">
            <div class="alert alert-danger" role="alert">
                <strong>알림:</strong> <span x-text="msg"></span>
            </div>
        </template>
        
        <template x-if="data.length > 0">
            <div>
                <div class="alert alert-success" role="alert">
                    <strong>조회 성공!</strong> <span x-text="data.length"></span>개의 결과가 있습니다.
                </div>
                
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center">No</th> 
                                <th>종목코드</th>
                                <th>종목명</th>
                                <th>시장명</th>
                                <th class="text-end">업종명</th>
                                <th class="text-end">상장주식수</th>
                                <th class="text-center">상장일</th>
                                <th class="text-end">전일종가</th>
                                <th class="text-center">NXT가능여부</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="(item, index) in data" :key="item.종목코드 || index">
                                <tr>
                                    <td x-text="index + 1"></td>
                                    <td>
                                        <a href="javascript:void(0);" @click="goNaver(item.종목코드)" x-text="item.종목코드 || '-'"></a>
                                    </td>
                                    <td>
                                        <a href="javascript:void(0);" @click="showDetail(item)" x-text="item.종목명 || '-'"></a>
                                    </td>
                                    <td x-text="item.시장명  || '-'"></td>
                                    <td class="text-end" x-text="item.업종명 || '-'"></td>
                                    <td class="text-end" x-text="item.상장주식수 ? Number(item.상장주식수).toLocaleString() : '-'"></td>
                                    <td class="text-center" x-text="item.상장일 ? (item.상장일.length === 8 ? `${item.상장일.slice(0,4)}-${item.상장일.slice(4,6)}-${item.상장일.slice(6,8)}` : item.상장일) : '-'"></td>
                                    <td class="text-end" x-text="item.전일종가 ? Number(item.전일종가).toLocaleString() : '-'"></td>
                                    <td class="text-center" x-text="item.NXT가능여부 || '-'"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </template>
        
        <template x-if="loading">
            <div class="text-center py-4">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">데이터를 불러오는 중...</p>
            </div>
        </template>
    </div>
</div>
{% raw %}
<!--handlebar scripts-->
{% endraw %}
{% endblock %}
{% block script %}
<script src="/public/js/fetch-util.js"></script>
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('stock_find', () => {
        return {
            loading: false,
            msg: null,
            keyword:null,
            mrkt_tp_kospi: true,
            mrkt_tp_kosdaq: false,
            mrkt_tp_etf: false,
            data : [],
            init(){
                console.log('stock_find 초기화 완료');
            },
            async submit(){
                this.msg = null;
                this.data = [];
            
                // Check if all mrkt_tp are false
                if (!this.mrkt_tp_kospi && !this.mrkt_tp_kosdaq && !this.mrkt_tp_etf) {
                    this.msg = "시장구분은 하나 이상 선택해야 합니다.";
                    return;
                }
                
                this.loading = true;
                let mrktTypes = [];
                if (this.mrkt_tp_kospi) mrktTypes.push("0");
                if (this.mrkt_tp_kosdaq) mrktTypes.push("10");
                if (this.mrkt_tp_etf) mrktTypes.push("30");

                let allResults = [];
                try {
                    console.log('검색 시작:', mrktTypes);
                    
                    for (const mrkt_tp of mrktTypes) {
                        console.log(`${mrkt_tp} 시장 조회 중...`);
                        let payload = { "mrkt_tp": mrkt_tp };
                        
                        // callKiwoomApi 함수 사용
                        let response = await callKiwoomApi('ka10099', payload);
                        
                        console.log(`${mrkt_tp} 시장 응답:`, response);
                        
                        if (response.success && response.data) {
                            // 응답 데이터 구조 확인 후 배열 추출
                            let items = response.data.종목리스트 || [];
                            allResults = allResults.concat(items);
                        }
                    }
                    
                    console.log('전체 조회 결과:', allResults);
                    
                    // Filter by keyword if present
                    if (this.keyword && this.keyword.trim() !== "") {
                        const keyword = this.keyword.trim();
                        allResults = allResults.filter(item =>
                            (item.종목명 && item.종목명.includes(keyword)) ||
                            (item.종목코드 && item.종목코드.includes(keyword))
                        );
                        console.log('키워드 필터링 후:', allResults);
                    }
                    
                    this.data = allResults;
                    this.msg = allResults.length > 0 ? null : "검색 결과가 없습니다.";
                    
                } catch (error) {
                    console.error('조회 오류:', error);
                    this.msg = '조회 중 오류가 발생했습니다: ' + error.message;
                } finally {
                    this.loading = false;
                }
            },
            // 하단offCanvas로  상세 정보 표시 메서드 추가
            showDetail(item) {
                // 상세 정보 표시 로직
                console.log('상세 정보:', item);
                showCompanyCanvas(item.종목코드);
            },
            goNaver(stk_code) {
                const url = `https://finance.naver.com/item/main.naver?code=${stk_code}`;
                window.open(url, '_blank');
            }
        }
    });
});
</script>
{% endblock %}
