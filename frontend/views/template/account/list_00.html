<!--
    - 이 템플릿은 계좌의 요약 정보와 종목별 평가 현황을 Alpine.js로 동적으로 표시합니다.
    - summary_full 체크박스로 상세 요약정보를 토글할 수 있습니다.
    - fetch_kiwoom() 함수는 API를 호출하여 데이터를 갱신합니다.
    - 각 데이터는 toLocaleString()으로 통화 형식으로 표시됩니다.
    - 손익금액/손익율은 양수/음수에 따라 색상이 다르게 표시됩니다.
TODO: 
    1. head click sorting, summary 더 예쁘게, 새로고침 5초마다 refrsh
    2. 종목코드 클릭, 종목명 클릭(상세정보)
    3. csv저장, 엑셀저장


-->
{% extends 'common/base.html' %}
{% block style %}
{% endblock %}
{% block content %}
<div x-data="kt00004_component" x-init="fetch_kiwoom()">

  <div class="container mt-4">
    <div class="alert alert-danger" x-show="return_code !== 0">
        <strong>오류:</strong> <span x-text="return_msg"></span>
    </div>
    <div class="d-flex align-items-center">
        <span x-text="data?.계좌명"></span>
        <span class="ms-2">(<span x-text="data?.지점명"></span>)</span>
        <div class="form-check ms-3 mt-0">
          <input class="form-check-input" type="checkbox" id="summaryFullCheck" x-model="summary_full">
          <label class="form-check-label" for="summaryFullCheck">full</label>
        </div>
        <!-- <button class="btn btn-primary" @click="fetch_kiwoom()">새로고침</button> -->
        <button class="btn btn-outline-secondary ms-2" @click="fetch_kiwoom()" title="새로고침">
            <i class="fa fa-refresh"></i>
        </button>
    </div>
    <table class="mt-2 table table-bordered table-striped align-middle">
      <tbody>
        <tr>
          <th class="bg-light">예수금</th>
          <td class="text-end" x-text="Number(data?.예수금).toLocaleString() + ' 원'"></td>

          <th class="bg-light">D+2추정예수금</th>
          <td class="text-end" x-text="Number(data?.['D+2추정예수금']).toLocaleString() + ' 원'"></td>
        </tr>
        <tr>
          <th class="bg-light">유가잔고평가액</th>
          <td class="text-end" x-text="Number(data?.유가잔고평가액).toLocaleString() + ' 원'"></td>

          <th class="bg-light">예탁자산평가액</th>
          <td class="text-end" x-text="Number(data?.예탁자산평가액).toLocaleString() + ' 원'"></td>
        </tr>
        <tr>
          <th class="bg-light">총매입금액</th>
          <td class="text-end" x-text="Number(data?.총매입금액).toLocaleString() + ' 원'"></td>

          <th class="bg-light">추정예탁자산</th>
          <td class="text-end" x-text="Number(data?.추정예탁자산).toLocaleString() + ' 원'"></td>
        </tr>
        <tr x-show="summary_full">
          <th class="bg-light">매도담보대출금</th>
          <td class="text-end" x-text="Number(data?.매도담보대출금).toLocaleString() + ' 원'"></td>

          <th class="bg-light">당일투자원금</th>
          <td class="text-end" x-text="Number(data?.당일투자원금).toLocaleString() + ' 원'"></td>
        </tr>
        <tr x-show="summary_full">
          <th class="bg-light">당월투자원금</th>
          <td class="text-end" x-text="Number(data?.당월투자원금).toLocaleString() + ' 원'"></td>

          <th class="bg-light">누적투자원금</th>
          <td class="text-end" x-text="Number(data?.누적투자원금).toLocaleString() + ' 원'"></td>
        </tr>
        <tr x-show="summary_full">
          <th class="bg-light">당일투자손익</th>
          <td class="text-end text-danger" x-text="Number(data?.당일투자손익).toLocaleString() + ' 원'"></td>

          <th class="bg-light">당월투자손익</th>
          <td class="text-end text-danger" x-text="Number(data?.당월투자손익).toLocaleString() + ' 원'"></td>
        </tr>
        <tr x-show="summary_full">
          <th class="bg-light">누적투자손익</th>
          <td class="text-end text-danger" x-text="Number(data?.누적투자손익).toLocaleString() + ' 원'"></td>

          <th class="bg-light">당일손익율</th>
          <td class="text-end" x-text="data?.당일손익율 + ' %'"></td>
        </tr>
        <tr x-show="summary_full">
          <th class="bg-light">당월손익율</th>
          <td class="text-end" x-text="data?.당월손익율 + ' %'"></td>

          <th class="bg-light">누적손익율</th>
          <td class="text-end" x-text="data?.누적손익율 + ' %'"></td>
        </tr>
      </tbody>
    </table>
    <div class="mt-4">
        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle text-center">
                <thead class="table-light">
                <tr>
                    <th>
                        <a href="#" @click.prevent="sortBy('종목코드')" class="text-decoration-none text-dark" style="cursor: pointer;">
                            종목코드
                            <span x-show="sort_key === '종목코드'" x-text="sort_asc ? '▲' : '▼'"></span>
                        </a>
                    </th>
                    <th>
                        <a href="#" @click.prevent="sortBy('종목명')" class="text-decoration-none text-dark" style="cursor: pointer;">
                            종목명
                            <span x-show="sort_key === '종목명'" x-text="sort_asc ? '▲' : '▼'"></span>
                        </a>
                    </th>
                    <th>
                        <a href="#" @click.prevent="sortBy('보유수량')" class="text-decoration-none text-dark" style="cursor: pointer;">
                            보유수량
                            <span x-show="sort_key === '보유수량'" x-text="sort_asc ? '▲' : '▼'"></span>
                        </a>
                    </th>
                    <th>
                        <a href="#" @click.prevent="sortBy('평균단가')" class="text-decoration-none text-dark" style="cursor: pointer;">
                            평균단가
                            <span x-show="sort_key === '평균단가'" x-text="sort_asc ? '▲' : '▼'"></span>
                        </a>
                    </th>
                    <th>
                        <a href="#" @click.prevent="sortBy('현재가')" class="text-decoration-none text-dark" style="cursor: pointer;">
                            현재가
                            <span x-show="sort_key === '현재가'" x-text="sort_asc ? '▲' : '▼'"></span>
                        </a>
                    </th>
                    <th>
                        <a href="#" @click.prevent="sortBy('평가금액')" class="text-decoration-none text-dark" style="cursor: pointer;">
                            평가금액
                            <span x-show="sort_key === '평가금액'" x-text="sort_asc ? '▲' : '▼'"></span>
                        </a>
                    </th>
                    <th>
                        <a href="#" @click.prevent="sortBy('손익금액')" class="text-decoration-none text-dark" style="cursor: pointer;">
                            손익금액
                            <span x-show="sort_key === '손익금액'" x-text="sort_asc ? '▲' : '▼'"></span>
                        </a>
                    </th>
                    <th>
                        <a href="#" @click.prevent="sortBy('손익율')" class="text-decoration-none text-dark" style="cursor: pointer;">
                            손익율
                            <span x-show="sort_key === '손익율'" x-text="sort_asc ? '▲' : '▼'"></span>
                        </a>
                    </th>
                    <th>
                        <a href="#" @click.prevent="sortBy('대출일')" class="text-decoration-none text-dark" style="cursor: pointer;">
                            대출일
                            <span x-show="sort_key === '대출일'" x-text="sort_asc ? '▲' : '▼'"></span>
                        </a>
                    </th>
                    <th>
                        <a href="#" @click.prevent="sortBy('매입금액')" class="text-decoration-none text-dark" style="cursor: pointer;">
                            매입금액
                            <span x-show="sort_key === '매입금액'" x-text="sort_asc ? '▲' : '▼'"></span>
                        </a>
                    </th>
                    <th>
                        <a href="#" @click.prevent="sortBy('결제잔고')" class="text-decoration-none text-dark" style="cursor: pointer;">
                            결제잔고
                            <span x-show="sort_key === '결제잔고'" x-text="sort_asc ? '▲' : '▼'"></span>
                        </a>
                    </th>
                    <th>전일매수</th>
                    <th>전일매도</th>
                    <th>금일매수</th>
                    <th>금일매도</th>
                </tr>
                </thead>
                <tbody>
                <!-- <template x-for="item in data?.종목별계좌평가현황" :key="item.종목코드"> -->
                <template x-for="item in sorted_items" :key="item.종목코드">
                    <tr>
                    <td x-text="item.종목코드"></td>
                    <td x-text="item.종목명"></td>
                    <td x-text="Number(item.보유수량).toLocaleString()"></td>
                    <td x-text="Number(item.평균단가).toLocaleString()"></td>
                    <td x-text="Number(item.현재가).toLocaleString()"></td>
                    <td x-text="Number(item.평가금액).toLocaleString()"></td>
                    <td x-text="Number(item.손익금액).toLocaleString()"
                        :class="Number(item.손익금액) > 0 ? 'text-danger' : (Number(item.손익금액) < 0 ? 'text-primary' : '')">
                    </td>
                    <td x-text="item.손익율 + ' %'"
                        :class="Number(item.손익율) > 0 ? 'text-danger' : (Number(item.손익율) < 0 ? 'text-primary' : '')">
                    </td>
                    <td x-text="item.대출일"></td>
                    <td x-text="Number(item.매입금액).toLocaleString()"></td>
                    <td x-text="Number(item.결제잔고).toLocaleString()"></td>
                    <td x-text="Number(item.전일매수수량).toLocaleString()"></td>
                    <td x-text="Number(item.전일매도수량).toLocaleString()"></td>
                    <td x-text="Number(item.금일매수수량).toLocaleString()"></td>
                    <td x-text="Number(item.금일매도수량).toLocaleString()"></td>
                    </tr>
                </template>
                </tbody>
            </table>

        </div>        
    </div>
  </div>
</div>
{% raw %}
<!--handlebar scripts-->
{% endraw %}
{% endblock %}
{% block script %}
{% raw %}
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('kt00004_component', () => ({
            data: null,
            return_msg : null,
            return_code : 0,
            sort_key : '종목코드',
            sort_asc : true,

            summary_full : false, //전체보기

            sortBy(key) {
                if (this.sort_key === key) {
                    this.sort_asc = !this.sort_asc;
                } else {
                    this.sort_key = key;
                    this.sort_asc = true;
                }
            },            
            get sorted_items() {
                if (!this.data?.종목별계좌평가현황) return [];

                return [...this.data.종목별계좌평가현황].sort((a, b) => {
                    let valA = a[this.sort_key];
                    let valB = b[this.sort_key];

                    // 숫자인 경우 정렬
                    if (!isNaN(parseFloat(valA)) && !isNaN(parseFloat(valB))) {
                        valA = parseFloat(valA);
                        valB = parseFloat(valB);
                    }

                    if (valA < valB) return this.sort_asc ? -1 : 1;
                    if (valA > valB) return this.sort_asc ? 1 : -1;
                    return 0;
                });
            },            
            async fetch_kiwoom() {
                try {
                    const payload = {
                        qry_tp: "0",
                        dmst_stex_tp: "KRX"
                    };

                    // 계좌평가현황요청
                    const response = await callKiwoomApi('kt00004', payload);
                    if (response.success) {
                        this.data = response.data
                        this.return_msg = response.data.return_msg || '주문이 성공적으로 처리되었습니다.';
                        this.return_code = response.data.return_code
                        console.log('응답:', response.data);
                    } else {
                        throw new Error(response.error_message || '알 수 없는 오류가 발생했습니다.');
                    }
                } catch (err) {
                    if (err instanceof KiwiError) {
                        this.error = `에러 ${err.status}: ${err.message}`;
                    } else {
                        this.error = '에러: ' + err.message;
                    }
                    console.error('주문 처리 오류:', err);
                    this.return_code = -1;
                    this.return_msg = '오류 발생: ' + err.message;
                }
            }
        }))
    });
</script>
{% endraw %}
{% endblock %}
