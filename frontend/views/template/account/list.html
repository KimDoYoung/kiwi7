<!--
    - 이 템플릿은 계좌의 요약 정보와 종목별 평가 현황을 Alpine.js로 동적으로 표시합니다.
    - summary_full 체크박스로 상세 요약정보를 토글할 수 있습니다.
    - fetch_kiwoom() 함수는 API를 호출하여 데이터를 갱신합니다.
    - 각 데이터는 toLocaleString()으로 통화 형식으로 표시됩니다.
    - 손익금액/손익율은 양수/음수에 따라 색상이 다르게 표시됩니다.
-->
{% extends 'common/base.html' %}
{% block style %}
<style>
</style>
{% endblock %}
{% block content %}
<div class="container mt-4" x-data="kt00004_component"  >
    <!-- 계좌명과 헤드 시작-->
    <div class="d-flex align-items-center">
        <span x-text="data?.계좌명"></span>
        <span class="ms-2">(<span x-text="data?.지점명"></span>)</span>
        <div class="form-check ms-3 mt-0">
            <input class="form-check-input" type="checkbox" id="summaryFullCheck" x-model="summary_show">
            <label class="form-check-label" for="summaryFullCheck">계좌상세</label>
        </div>
    </div> 
    <div class="d-flex align-items-center mt-2 gap-4">
        <div>
            <span>자산:</span>
            <span class="fw-bold" x-text="Number(data?.추정예탁자산).toLocaleString() + ' 원'"></span>
        </div>
        <div>
            <span>수익:</span>
            <span class="fw-bold" x-text="profit.toLocaleString() + ' 원'" :class="formatClass(profit)"></span>
        </div>
        <div>
            <span>매수가능:</span>
            <span class="fw-bold" x-text="Number(data?.['D+2추정예수금']).toLocaleString() + ' 원'"></span>
        </div>
    </div>
    <!-- 계좌명과 헤드 끝-->
    <!-- 계좌 요약 정보 시작--> 
    <div class="rounded-3 shadow-sm bg-white p-1 mt-4" x-show="summary_show">
        <table class="mt-2 table table-bordered table-striped align-middle">
        <tbody>
            <tr>
            <th class="bg-light">예수금</th>
            <td class="text-end" x-text="Number(data?.예수금).toLocaleString() + ' 원'"></td>

            <th class="bg-light">D+2추정예수금</th>
            <td class="text-end fw-bold" x-text="Number(data?.['D+2추정예수금']).toLocaleString() + ' 원'"></td>
            </tr>
            <tr>
            <th class="bg-light">유가잔고평가액</th>
            <td class="text-end" x-text="Number(data?.유가잔고평가액).toLocaleString() + ' 원'"></td>

            <th class="bg-light">예탁자산평가액</th>
            <td class="text-end" x-text="Number(data?.예탁자산평가액).toLocaleString() + ' 원'"></td>
            </tr>
            <tr>
            <th class="bg-light">총매입금액</th>
            <td class="text-end" x-text="Number(data?.총매입금액).toLocaleString() + ' 원'"></td>

            <th class="bg-light">추정예탁자산</th>
            <td class="text-end" x-text="Number(data?.추정예탁자산).toLocaleString() + ' 원'"></td>
            </tr>
            <tr>
            <th class="bg-light">매도담보대출금</th>
            <td class="text-end" x-text="Number(data?.매도담보대출금).toLocaleString() + ' 원'"></td>

            <th class="bg-light">당일투자원금</th>
            <td class="text-end" x-text="Number(data?.당일투자원금).toLocaleString() + ' 원'"></td>
            </tr>
            <tr>
            <th class="bg-light">당월투자원금</th>
            <td class="text-end" x-text="Number(data?.당월투자원금).toLocaleString() + ' 원'"></td>

            <th class="bg-light">누적투자원금</th>
            <td class="text-end" x-text="Number(data?.누적투자원금).toLocaleString() + ' 원'"></td>
            </tr>
            <tr>
            <th class="bg-light">당일투자손익</th>
            <td class="text-end text-danger" x-text="Number(data?.당일투자손익).toLocaleString() + ' 원'"></td>

            <th class="bg-light">당월투자손익</th>
            <td class="text-end text-danger" x-text="Number(data?.당월투자손익).toLocaleString() + ' 원'"></td>
            </tr>
            <tr>
            <th class="bg-light">누적투자손익</th>
            <td class="text-end text-danger" x-text="Number(data?.누적투자손익).toLocaleString() + ' 원'"></td>

            <th class="bg-light">당일손익율</th>
            <td class="text-end" x-text="data?.당일손익율 + ' %'"></td>
            </tr>
            <tr>
            <th class="bg-light">당월손익율</th>
            <td class="text-end" x-text="data?.당월손익율 + ' %'"></td>

            <th class="bg-light">누적손익율</th>
            <td class="text-end" x-text="data?.누적손익율 + ' %'"></td>
            </tr>
        </tbody>
        </table>

    </div>

    <!-- 계좌 요약 정보 끝--> 
    <div class="mt-4">
        <div class="mt-2 mb-2 d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">
                <select class="form-select form-select-sm w-auto" x-model="profitFilter">
                    <option value="all">전체</option>
                    <option value="plus">+손익율</option>
                    <option value="minus">-손익율</option>
                </select>
                <div>종목갯수 : <span x-text="filtered_item_count"></span> / <span x-text="total_item_count"></span></div>
            </div>
            <button class="btn btn-outline-success btn-sm" title="엑셀로 저장" @click="exportCSV()">
                <i class="fa fa-file-excel"></i>
            </button>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle text-center">
                <thead class="table-light">
                    <tr>
                        <template x-for="column in getTableColumns()" :key="column.key">
                            <th>
                                <template x-if="column.sortable">
                                    <a href="#" @click.prevent="sortBy(column.key)" 
                                        class="text-decoration-none text-dark sortable-header">
                                        <span x-text="column.label"></span>
                                        <span x-show="sort_key === column.key" 
                                                x-text="sort_asc ? '▲' : '▼'"></span>
                                    </a>
                                </template>
                                <template x-if="!column.sortable">
                                    <span x-text="column.label"></span>
                                </template>
                            </th>
                        </template>
                        <template x-if="hasActionButtons()">
                            <th>Actions</th>
                        </template>
                    </tr>
                </thead>
                <tbody x-show="data && !loading">
                    <template x-for="item in sorted_items" :key="item.종목코드">
                        <tr>
                            <template x-for="column in getTableColumns()" :key="column.key">
                                <td x-text="getCellValue(item, column)"
                                    :class="getCellClass(item, column) + (column.clickable ? ' clickable-cell' : '') + ((column.format === 'number' || column.format === 'profit') ? ' text-end' : '')"
                                    @click="handleCellClick(item, column)">
                                </td>
                            </template>
                            <template x-if="hasActionButtons()">
                                <td>
                                    <div class="btn-group" role="group">
                                        <template x-if="actions.includes('buy')">
                                            <button type="button" class="btn btn-sm btn-danger" @click="buy(item)" title="매수(buy)">買</button>
                                        </template>
                                        <template x-if="actions.includes('sell')">
                                            <button type="button" class="btn btn-sm btn-primary" @click="sell(item)" title="매도(sell)">賣</button>
                                        </template>
                                        <template x-if="actions.includes('detail')">
                                            <button type="button" class="btn btn-sm btn-info" @click="detail(item)" title="종목상세(detail info)">詳</button>
                                        </template>
                                    </div>
                                </td>
                            </template>
                        </tr>
                    </template>
                </tbody>
                <tbody x-show="loading">
                    <tr>
                        <td :colspan="getTableColumns().length" class="text-center py-4">
                            <i class="fa fa-spinner fa-spin"></i> 데이터를 불러오는 중...
                        </td>
                    </tr>
                </tbody>
                <tbody x-show="!loading && (!data || sorted_items.length === 0)">
                    <tr>
                        <td :colspan="getTableColumns().length" class="text-center py-4 text-muted">
                            표시할 데이터가 없습니다.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>        
    </div> 
    <!-- 데이터 테이블 끝-->   
</div>
{% raw %}
<!--handlebar scripts-->
{% endraw %}
{% endblock %}
{% block script %}
<script src="/public/js/configs/kiwoom/kt00004.js"></script>
<script src="/public/js/utils/kiwoom-utils.js"></script>
<script src="/public/js/components/kiwoom-base.js"></script>
{% raw %}
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('kt00004_component', () => {
        let base = window.createKiwoomBase(kt00004, {
            callApi : callKiwoomApi,
            utils : window.KiwoomUtils,
            debug: false
        });
        return {
            ...base,
            summary_show: false,
            profit: 0,
            profitFilter: 'all',
            // data: null,
            init(){
                if(base.init) {
                    base.init.call(this);
                }
                // 필터 변경 감시
                this.$watch('profitFilter', (newValue, oldValue) => {
                    console.log('profitFilter changed from', oldValue, 'to', newValue);
                    this.clearFilters(); 
                    this.onProfitFilterChange(newValue);
                });
                
                // 콜백 등록
                this.addCallback((data) => {
                    this.profit = data?.['유가잔고평가액'] - data?.['총매입금액'];
                });
                // add 종목명 클릭 handler
                this.addClickHandler('종목명', (item) => {
                    console.log('종목명 클릭:', item);
                    showCompanyCanvas(item.종목코드);
                }); 
            },
            get total_item_count(){
                return this.totalItemCount() || 0;
            },
            onProfitFilterChange(filterValue) {
                console.log('필터가 변경되었습니다:', filterValue);
                this.clearFilters();
                if (filterValue === 'plus') {
                    this.addFilter(item => item.손익율 > 0);
                } else if (filterValue === 'minus') {
                    this.addFilter(item => item.손익율 < 0);
                }
            }, 
            get sorted_items() {
                return this.sortedItems();
            },
            get total_item_count() {
                return this.totalItemCount() ;
            },
            get filtered_item_count() {
                return this.filteredItemCount();
            },
            get actions(){
                return this.getActions();
            },
            buy(item) {
                console.log('구매:', item);
                let stk_code  = item.종목코드;
                let stk_name = item.종목명;
                // let qty = item.보유수량 || 0;
                // 기존 showBuySellCanvas 호출 대신 offcanvasBuySell 토글
                showBuySellCanvas({
                    stk_code: stk_code,
                    stk_name: stk_name,
                    which: '매수',
                    qty: 1,
                    cost: item.매입가 || 0
                });
            },
            sell(item) {
                console.log('판매:', item);
                let stk_code  = item.종목코드;
                let stk_name = item.종목명;
                let qty = Number(item.보유수량) || 0;
                // let qty = item.보유수량 || 0;
                // 기존 showBuySellCanvas 호출 대신 offcanvasBuySell 토글
                showBuySellCanvas({
                    stk_code: stk_code,
                    stk_name: stk_name,
                    which: '매도',
                    qty: qty,
                    cost:  0
                });
            },
            detail(item) {
                console.log('상세 정보:', item);
                // 종목 상세 정보를 보여주는 로직을 여기에 추가
                showCompanyCanvas(item.종목코드);
            },
            formatClass(value) {
                if (value > 0) {
                    return 'text-danger';
                } else if (value < 0) {
                    return 'text-primary';
                }
                return '';
            }
        }
    });

});
</script>
{% endraw %}
{% endblock %}
