<!--
    - kt00004(계좌평가현황), kt10075(미체결요청), kt100076(체결요청) 
    - 이 템플릿은 계좌의 요약 정보와 종목별 평가 현황을 Alpine.js로 동적으로 표시합니다.
    - summary_full 체크박스로 상세 요약정보를 토글할 수 있습니다.
    - fetch_kiwoom() 함수는 API를 호출하여 데이터를 갱신합니다.
    - 각 데이터는 toLocaleString()으로 통화 형식으로 표시됩니다.
    - 손익금액/손익율은 양수/음수에 따라 색상이 다르게 표시됩니다.
    TODO : 새로고침 스위치 넣기 
-->
{% extends 'common/base.html' %}
{% block style %}
<style>
.spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.clickable-cell {
    cursor: pointer;
}

.clickable-cell:hover {
    background-color: #f8f9fa;
}

.sortable-header {
    cursor: pointer;
}

.sortable-header:hover {
    background-color: #e9ecef;
}
</style>
{% endblock %}
{% block content %}
<div class="container mt-4" x-data="kt00004_component"  >
    <!-- 계좌명과 헤드 시작-->
    <div class="d-flex align-items-center">
        <span x-text="data?.계좌명"></span>
        <span class="ms-2">(<span x-text="data?.지점명"></span>)</span>
        <div class="form-check ms-3 mt-0">
            <input class="form-check-input" type="checkbox" id="summaryFullCheck" x-model="summary_show">
            <label class="form-check-label" for="summaryFullCheck">현황상세</label>
        </div>
        <div class="form-check form-switch ms-3 mt-0">
            <input class="form-check-input" type="checkbox" id="autoRefreshCheck" x-model="autoRefresh">
            <label class="form-check-label fw-bold" for="autoRefreshCheck">
                자동 새로고침 
                <span x-show="!autoRefresh" class="badge bg-secondary ms-1">30초</span>
                <span x-show="autoRefresh" 
                      :class="`badge ms-1 ${countdown <= 5 ? 'bg-warning' : 'bg-primary'}`" 
                      x-text="`${countdown}초`"></span>
            </label>
        </div>
    </div> 
    <div class="d-flex align-items-center mt-2 gap-4">
        <div>
            <span>자산:</span>
            <span class="fw-bold" x-text="Number(data?.추정예탁자산).toLocaleString() + ' 원'"></span>
        </div>
        <div>
            <span>수익:</span>
            <span class="fw-bold" x-text="profit.toLocaleString() + ' 원'" :class="formatClass(profit)"></span>
        </div>
        <div>
            <span>매수가능:</span>
            <span class="fw-bold" x-text="Number(data?.['D+2추정예수금']).toLocaleString() + ' 원'"></span>
        </div>
    </div>
    <!-- 계좌명과 헤드 끝-->
    <!-- 계좌 요약 정보 시작--> 
    <div class="rounded-3 shadow-sm bg-white p-1 mt-4" x-show="summary_show">
        <table class="mt-2 table table-bordered table-striped align-middle">
        <tbody>
            <tr>
            <th class="bg-light">예수금</th>
            <td class="text-end" x-text="Number(data?.예수금).toLocaleString() + ' 원'"></td>

            <th class="bg-light">D+2추정예수금</th>
            <td class="text-end fw-bold" x-text="Number(data?.['D+2추정예수금']).toLocaleString() + ' 원'"></td>
            </tr>
            <tr>
            <th class="bg-light">유가잔고평가액</th>
            <td class="text-end" x-text="Number(data?.유가잔고평가액).toLocaleString() + ' 원'"></td>

            <th class="bg-light">예탁자산평가액</th>
            <td class="text-end" x-text="Number(data?.예탁자산평가액).toLocaleString() + ' 원'"></td>
            </tr>
            <tr>
            <th class="bg-light">총매입금액</th>
            <td class="text-end" x-text="Number(data?.총매입금액).toLocaleString() + ' 원'"></td>

            <th class="bg-light">추정예탁자산</th>
            <td class="text-end" x-text="Number(data?.추정예탁자산).toLocaleString() + ' 원'"></td>
            </tr>
            <tr>
            <th class="bg-light">매도담보대출금</th>
            <td class="text-end" x-text="Number(data?.매도담보대출금).toLocaleString() + ' 원'"></td>

            <th class="bg-light">당일투자원금</th>
            <td class="text-end" x-text="Number(data?.당일투자원금).toLocaleString() + ' 원'"></td>
            </tr>
            <tr>
            <th class="bg-light">당월투자원금</th>
            <td class="text-end" x-text="Number(data?.당월투자원금).toLocaleString() + ' 원'"></td>

            <th class="bg-light">누적투자원금</th>
            <td class="text-end" x-text="Number(data?.누적투자원금).toLocaleString() + ' 원'"></td>
            </tr>
            <tr>
            <th class="bg-light">당일투자손익</th>
            <td class="text-end text-danger" x-text="Number(data?.당일투자손익).toLocaleString() + ' 원'"></td>

            <th class="bg-light">당월투자손익</th>
            <td class="text-end text-danger" x-text="Number(data?.당월투자손익).toLocaleString() + ' 원'"></td>
            </tr>
            <tr>
            <th class="bg-light">누적투자손익</th>
            <td class="text-end text-danger" x-text="Number(data?.누적투자손익).toLocaleString() + ' 원'"></td>

            <th class="bg-light">당일손익율</th>
            <td class="text-end" x-text="data?.당일손익율 + ' %'"></td>
            </tr>
            <tr>
            <th class="bg-light">당월손익율</th>
            <td class="text-end" x-text="data?.당월손익율 + ' %'"></td>

            <th class="bg-light">누적손익율</th>
            <td class="text-end" x-text="data?.누적손익율 + ' %'"></td>
            </tr>
        </tbody>
        </table>

    </div>

    <!-- 계좌 요약 정보 끝--> 
    <div class="mt-4">
        <div class="mt-2 mb-2 d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">
                <select class="form-select form-select-sm w-auto" x-model="profitFilter">
                    <option value="all">전체</option>
                    <option value="plus">+손익율</option>
                    <option value="minus">-손익율</option>
                </select>
                <div>종목갯수 : <span x-text="filtered_item_count"></span> / <span x-text="total_item_count"></span></div>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-success btn-sm" title="엑셀로 저장" @click="exportCSV()">
                    <i class="bi bi-file-earmark-excel"></i>
                </button>
                <button class="btn btn-outline-success btn-sm" title="My Stock에 저장" @click="addMyStock()">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>            
        </div>
        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle text-center">
                <thead class="table-light">
                    <tr>
                        <template x-for="column in getTableColumns()" :key="column.key">
                            <th>
                                <template x-if="column.sortable">
                                    <a href="#" @click.prevent="sortBy(column.key)" 
                                        class="text-decoration-none text-dark sortable-header">
                                        <span x-text="column.label"></span>
                                        <span x-show="sort_key === column.key" 
                                                x-text="sort_asc ? '▲' : '▼'"></span>
                                    </a>
                                </template>
                                <template x-if="!column.sortable">
                                    <span x-text="column.label"></span>
                                </template>
                            </th>
                        </template>
                        <template x-if="hasActionButtons()">
                            <th>Actions</th>
                        </template>
                    </tr>
                </thead>
                <tbody x-show="data && !loading">
                    <template x-for="item in sorted_items" :key="item.종목코드">
                        <tr>
                            <template x-for="column in getTableColumns()" :key="column.key">
                                <td x-text="getCellValue(item, column)"
                                    :class="getCellClass(item, column) + (column.clickable ? ' clickable-cell' : '') + ((column.format === 'number' || column.format === 'profit') ? ' text-end' : '')"
                                    @click="handleCellClick(item, column)">
                                </td>
                            </template>
                            <template x-if="hasActionButtons()">
                                <td>
                                    <div class="btn-group" role="group">
                                        <template x-if="actions.includes('buy')">
                                            <button type="button" class="btn btn-sm btn-danger" @click="buy(item)" title="매수(buy)">買</button>
                                        </template>
                                        <template x-if="actions.includes('sell')">
                                            <button type="button" class="btn btn-sm btn-primary" @click="sell(item)" title="매도(sell)">賣</button>
                                        </template>
                                        <template x-if="actions.includes('detail')">
                                            <button type="button" class="btn btn-sm btn-info" @click="detail(item)" title="종목상세(detail info)">詳</button>
                                        </template>
                                    </div>
                                </td>
                            </template>
                        </tr>
                    </template>
                </tbody>
                <tbody x-show="loading">
                    <tr>
                        <td :colspan="getTableColumns().length" class="text-center py-4">
                            <i class="bi bi-arrow-clockwise" style="animation: spin 1s linear infinite;"></i> 데이터를 불러오는 중...
                        </td>
                    </tr>
                </tbody>
                <tbody x-show="!loading && (!data || sorted_items.length === 0)">
                    <tr>
                        <td :colspan="getTableColumns().length" class="text-center py-4 text-muted">
                            표시할 데이터가 없습니다.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>        
    </div> 
    <!-- 데이터 테이블 끝-->   
</div>
<div class="container mt-4" x-data="ka10075_component" > 
    <!-- 미체결 주문: 데이터 있을 때만 전체 영역 표시 -->
    <template x-if="items.length > 0">
        <div>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 x-text="title" class="mb-0"></h5>
                <div class="d-flex align-items-center gap-2">
                    <small class="text-muted">총 <span x-text="items.length"></span>건</small>
                    <button class="btn btn-outline-primary btn-sm" @click="fetchData()" :disabled="loading">
                        <i class="bi bi-arrow-clockwise" :class="{'spin': loading}"></i> 새로고침
                    </button>
                </div>
            </div>
            <div x-show="loading" class="text-center py-4">
                <i class="bi bi-arrow-clockwise spin"></i> 미체결 데이터를 불러오는 중...
            </div>
            <div x-show="!loading && items.length > 0" class="table-responsive">
                <table class="table table-bordered table-hover align-middle text-center">
                    <thead class="table-light">
                        <tr>
                            <th>시간</th>
                            <th>종목명</th>
                            <th>주문구분</th>
                            <th>주문가격</th>
                            <th>주문수량</th>
                            <th>미체결수량</th>
                            <th>현재가</th>
                            <th>주문상태</th>
                            <th>거래소</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="item in items" :key="item.주문번호">
                            <tr>
                                <td x-text="formatTime(item.시간)"></td>
                                <td x-text="item.종목명" class="text-start"></td>
                                <td>
                                    <span :class="item.주문구분.includes('매수') ? 'text-danger' : 'text-primary'" 
                                          x-text="item.주문구분"></span>
                                </td>
                                <td x-text="Number(item.주문가격).toLocaleString() + '원'" class="text-end"></td>
                                <td x-text="Number(item.주문수량).toLocaleString() + '주'" class="text-end"></td>
                                <td x-text="Number(item.미체결수량).toLocaleString() + '주'" class="text-end fw-bold text-warning"></td>
                                <td class="text-end">
                                    <span :class="getPriceClass(item.현재가)" 
                                          x-text="formatPriceText(item.현재가)"></span>
                                </td>
                                <td>
                                    <span :class="item.주문상태 === '접수' ? 'badge bg-info' : 'badge bg-secondary'" 
                                          x-text="item.주문상태"></span>
                                </td>
                                <td x-text="item.거래소구분텍스트"></td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                                @click="cancelOrder(item)" title="주문취소">취소</button>
                                        <button type="button" class="btn btn-sm btn-outline-info" 
                                                @click="modifyOrder(item)" title="주문수정">수정</button>
                                        <button type="button" class="btn btn-sm btn-outline-success" 
                                                @click="showDetail(item)" title="상세정보">詳</button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </template>
</div>

<div class="container mt-4" x-data="ka10076_component" > 
    <!-- 체결 주문: 데이터 있을 때만 전체 영역 표시 -->
    <template x-if="items.length > 0">
        <div>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 x-text="title" class="mb-0"></h5>
                <div class="d-flex align-items-center gap-2">
                    <small class="text-muted">총 <span x-text="items.length"></span>건</small>
                    <button class="btn btn-outline-primary btn-sm" @click="fetchData()" :disabled="loading">
                        <i class="bi bi-arrow-clockwise" :class="{'spin': loading}"></i> 새로고침
                    </button>
                </div>
            </div>
            <div x-show="loading" class="text-center py-4">
                <i class="bi bi-arrow-clockwise spin"></i> 체결 데이터를 불러오는 중...
            </div>
            <div x-show="!loading && items.length > 0" class="table-responsive">
                <table class="table table-bordered table-hover align-middle text-center">
                    <thead class="table-light">
                        <tr>
                            <th>주문시간</th>
                            <th>종목명</th>
                            <th>주문구분</th>
                            <th>매매구분</th>
                            <th>주문가격</th>
                            <th>체결가</th>
                            <th>주문수량</th>
                            <th>체결량</th>
                            <th>미체결수량</th>
                            <th>수수료</th>
                            <th>세금</th>
                            <th>주문상태</th>
                            <th>거래소</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="item in items" :key="item.주문번호">
                            <tr>
                                <td x-text="formatTime(item.주문시간)"></td>
                                <td x-text="item.종목명" class="text-start"></td>
                                <td>
                                    <span :class="item.주문구분.includes('매수') ? 'text-danger' : 'text-primary'" 
                                          x-text="item.주문구분"></span>
                                </td>
                                <td x-text="item.매매구분"></td>
                                <td class="text-end">
                                    <span x-text="formatOrderPrice(item.주문가격, item.매매구분)"></span>
                                </td>
                                <td x-text="Number(item.체결가).toLocaleString() + '원'" class="text-end fw-bold text-success"></td>
                                <td x-text="Number(item.주문수량).toLocaleString() + '주'" class="text-end"></td>
                                <td x-text="Number(item.체결량).toLocaleString() + '주'" class="text-end fw-bold text-primary"></td>
                                <td x-text="Number(item.미체결수량).toLocaleString() + '주'" class="text-end"></td>
                                <td x-text="Number(item.당일매매수수료).toLocaleString() + '원'" class="text-end text-muted"></td>
                                <td x-text="Number(item.당일매매세금).toLocaleString() + '원'" class="text-end text-muted"></td>
                                <td>
                                    <span class="badge bg-success" x-text="item.주문상태"></span>
                                </td>
                                <td x-text="item.거래소구분텍스트"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </template>
</div>

<!-- 미체결 주문 상세 정보 Modal -->
<div class="modal fade" id="unfillOrderDetailModal" tabindex="-1" aria-labelledby="unfillOrderDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="unfillOrderDetailModalLabel">미체결 주문 상세 정보</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <th class="bg-light">주문번호</th>
                                    <td id="modal-order-no"></td>
                                </tr>
                                <tr>
                                    <th class="bg-light">종목명</th>
                                    <td id="modal-stock-name"></td>
                                </tr>
                                <tr>
                                    <th class="bg-light">종목코드</th>
                                    <td id="modal-stock-code"></td>
                                </tr>
                                <tr>
                                    <th class="bg-light">주문구분</th>
                                    <td id="modal-order-type"></td>
                                </tr>
                                <tr>
                                    <th class="bg-light">매매구분</th>
                                    <td id="modal-trade-type"></td>
                                </tr>
                                <tr>
                                    <th class="bg-light">주문가격</th>
                                    <td id="modal-order-price"></td>
                                </tr>
                                <tr>
                                    <th class="bg-light">주문수량</th>
                                    <td id="modal-order-qty"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <th class="bg-light">미체결수량</th>
                                    <td id="modal-unfill-qty" class="fw-bold text-warning"></td>
                                </tr>
                                <tr>
                                    <th class="bg-light">체결누계금액</th>
                                    <td id="modal-fill-amount"></td>
                                </tr>
                                <tr>
                                    <th class="bg-light">현재가</th>
                                    <td id="modal-current-price"></td>
                                </tr>
                                <tr>
                                    <th class="bg-light">매수호가</th>
                                    <td id="modal-buy-price"></td>
                                </tr>
                                <tr>
                                    <th class="bg-light">매도호가</th>
                                    <td id="modal-sell-price"></td>
                                </tr>
                                <tr>
                                    <th class="bg-light">주문상태</th>
                                    <td id="modal-order-status"></td>
                                </tr>
                                <tr>
                                    <th class="bg-light">주문시간</th>
                                    <td id="modal-order-time"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
                            <div>
                                <strong>거래소:</strong> <span id="modal-exchange"></span>
                            </div>
                            <div>
                                <strong>원주문번호:</strong> <span id="modal-orig-order-no"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger" id="modal-cancel-order">주문 취소</button>
                <button type="button" class="btn btn-outline-info" id="modal-modify-order">주문 수정</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

{% raw %}
<!--handlebar scripts-->
{% endraw %}
{% endblock %}
{% block script %}
<script src="/public/js/configs/kiwoom/kt00004.js"></script>
<script src="/public/js/utils/kiwoom-utils.js"></script>
<script src="/public/js/components/kiwoom-base.js"></script>
{% raw %}
<script>
// Alpine 컴포넌트 팩토리 함수
function createKt00004Component() {
    const base = window.createKiwoomBase(kt00004, {
        callApi: callKiwoomApi,
        utils: window.KiwoomUtils,
        debug: false
    });

    return {
        ...base,
        
        // === 상태 변수 ===
        summary_show: false,
        profit: 0,
        profitFilter: 'all',
        autoRefresh: false,           // 자동 새로고침 스위치 상태
        countdownInterval: null,      // 카운트다운 인터벌 ID
        countdown: 30,                // 카운트다운 값

        // === 초기화 ===
        init() {
            this.initializeBase();
            this.setupWatchers();
            this.setupAutoRefreshWatcher();
            this.setupCleanup();
            this.registerCallbacks();
            this.registerClickHandlers();
        },

        initializeBase() {
            if (base.init) {
                base.init.call(this);
            }
        },

        setupWatchers() {
            this.$watch('profitFilter', (newValue, oldValue) => {
                console.log('profitFilter changed from', oldValue, 'to', newValue);
                this.clearFilters(); 
                this.onProfitFilterChange(newValue);
            });
        },

        // === 자동 새로고침 관리 ===
        setupAutoRefreshWatcher() {
            // autoRefresh 상태 변화 감지
            this.$watch('autoRefresh', (newValue) => {
                if (newValue) {
                    this.startAutoRefresh();
                } else {
                    this.stopAutoRefresh();
                }
            });
        },

        setupCleanup() {
            // 페이지 언로드 시 인터벌 정리
            window.addEventListener('beforeunload', () => {
                this.stopAutoRefresh();
            });
        },

        startAutoRefresh() {
            console.log('자동 새로고침 시작 (30초 간격)');
            this.countdown = 30;
            
            // 카운트다운 시작 (1초마다)
            this.countdownInterval = setInterval(() => {
                if (this.autoRefresh) {
                    this.countdown--;
                    
                    if (this.countdown <= 0) {
                        // 카운트다운이 0이 되면 새로고침 실행
                        if (!this.loading) {
                            console.log('자동 새로고침 실행...');
                            this.fetch_data(); // kiwoom-base의 fetch_data 함수 호출
                        }
                        this.countdown = 30; // 카운트다운 리셋
                    }
                }
            }, 1000); // 1초마다 카운트다운
        },

        stopAutoRefresh() {
            console.log('자동 새로고침 중지');
            if (this.countdownInterval) {
                clearInterval(this.countdownInterval);
                this.countdownInterval = null;
            }
            this.countdown = 30; // 카운트다운 리셋
        },

        registerCallbacks() {
            this.addCallback((data) => {
                this.profit = data?.['유가잔고평가액'] - data?.['총매입금액'];
            });
        },

        registerClickHandlers() {
            this.addClickHandler('종목명', (item) => {
                console.log('종목명 클릭:', item);
                showCompanyCanvas(item.종목코드);
            });
        },

        // === 계산된 속성 ===
        get sorted_items() {
            return this.sortedItems();
        },

        get total_item_count() {
            return this.totalItemCount() || 0;
        },

        get filtered_item_count() {
            return this.filteredItemCount();
        },

        get actions() {
            return this.getActions();
        },

        // === 필터링 메서드 ===
        onProfitFilterChange(filterValue) {
            console.log('필터가 변경되었습니다:', filterValue);
            this.clearFilters();
            
            switch (filterValue) {
                case 'plus':
                    this.addFilter(item => item.손익율 > 0);
                    break;
                case 'minus':
                    this.addFilter(item => item.손익율 < 0);
                    break;
                // 'all'은 필터를 추가하지 않음
            }
        },

        // === 액션 메서드 ===
        buy(item) {
            console.log('구매:', item);
            const { 종목코드: stk_code, 종목명: stk_name, 매입가 } = item;
            
            showBuySellCanvas({
                stk_code,
                stk_name,
                which: '매수',
                qty: 1,
                cost: 매입가 || 0
            });
        },

        sell(item) {
            console.log('판매:', item);
            const { 종목코드: stk_code, 종목명: stk_name, 보유수량 } = item;
            const qty = Number(보유수량) || 0;
            
            showBuySellCanvas({
                stk_code,
                stk_name,
                which: '매도',
                qty,
                cost: 0
            });
        },

        detail(item) {
            console.log('상세 정보:', item);
            showCompanyCanvas(item.종목코드);
        },

        // === 유틸리티 메서드 ===
        formatClass(value) {
            if (value > 0) return 'text-danger';
            if (value < 0) return 'text-primary';
            return '';
        },
        addMyStock() {
            let list = this.data["종목별계좌평가현황"]
            let codes = []
            for (let i = 0; i < list.length; i++) {
                code  = list[i]["종목코드"]
                if (!/^[0-9]+$/.test(code)) {
                    code = code.replace(/[^0-9]/g, '')
                } 
                codes.push(code)
            }
            postFetch('/api/v1/mystock/bulk', {
                api_id: 'kiwi7_mystock_bulk_add',
                payload: {
                    codes : codes
                },
            }).then(response => {
                if (response.success) {
                    showAlert('My Stock에 추가되었습니다.', 'success');
                } else {
                    showAlert('My Stock 추가에 실패했습니다: ' + response.error_message, 'error');
                }
            });
            console.log('My Stock에 추가:', this.data);
            // My Stock에 추가하는 로직 구현
        }
    };
}

function createKa10075Component() {
    return {
        title: '미체결 주문',
        loading: false,
        items: [],
        
        fetchData() {
            this.loading = true;
            const payload = {
                all_stk_tp: '0', // 0:전체, 1:종목
                trde_tp: '0',    // 0:전체, 1:매도, 2:매수
                stk_cd: '',      // 종목코드 (all_stk_tp가 1일 때 사용)
                stex_tp: '0'     // 0:통합, 1:KRX, 2:NXT
            };

            callKiwoomApi('ka10075', payload)
                .then(response => {
                    console.log('미체결 주문 데이터:', response);
                    if (response.success && response.data) {
                        // API 응답에서 미체결 주문 리스트 추출 (한글 키 사용)
                        this.items = response.data.미체결 || [];
                        console.log('미체결 주문 항목들:', this.items);
                    } else {
                        this.items = [];
                        console.error('미체결 주문 데이터 오류:', response.error_message);
                    }
                })
                .catch(error => {
                    console.error('미체결 주문 데이터 가져오기 오류:', error);
                    this.items = [];
                    showAlert('미체결 주문 데이터를 가져오는데 실패했습니다.', 'error');
                })
                .finally(() => {
                    this.loading = false;
                });
        },

        formatTime(timeStr) {
            if (!timeStr) return '';
            // HHMMSS 형식을 HH:MM:SS로 변환
            if (timeStr.length === 6) {
                return `${timeStr.slice(0,2)}:${timeStr.slice(2,4)}:${timeStr.slice(4,6)}`;
            }
            return timeStr;
        },

        formatPrice(priceStr) {
            if (!priceStr) return '0원';
            // 현재가에서 +/- 부호 제거하고 숫자만 추출
            const price = priceStr.toString().replace(/[+-]/g, '');
            const numPrice = Number(price);
            if (isNaN(numPrice)) return priceStr;
            
            return numPrice.toLocaleString() + '원';
        },

        formatPriceText(priceStr) {
            if (!priceStr) return '0원';
            // 현재가에서 +/- 부호 제거하고 숫자만 추출
            const price = priceStr.toString().replace(/[+-]/g, '');
            const numPrice = Number(price);
            if (isNaN(numPrice)) return priceStr;
            
            return numPrice.toLocaleString() + '원';
        },

        getPriceClass(priceStr) {
            if (!priceStr) return '';
            // 원래 값이 음수였다면 파란색, 양수면 빨간색
            const isNegative = priceStr.toString().startsWith('-');
            return isNegative ? 'text-primary' : 'text-danger';
        },

        cancelOrder(item) {
            console.log('주문 취소:', item);
            const confirmMsg = `${item.종목명} ${item.주문구분} 주문을 취소하시겠습니까?\n주문번호: ${item.주문번호}`;
            
            if (confirm(confirmMsg)) {
                const api_id = "kt10003";
                const payload = {
                    	"dmst_stex_tp" : item.거래소구분텍스트, //국내거래소구분
                        "orig_ord_no" : item.주문번호, //원주문번호
                        "stk_cd" : item.종목코드, //종목코드
                        "cncl_qty" : item.미체결수량 //취소수량
                }
                console.log(payload);
                callKiwoomApi(api_id, payload)
                    .then(response => {
                        console.log('주문 취소 응답:', response);
                        if (response.success) {
                            showAlert('주문이 성공적으로 취소되었습니다.', 'success');
                            this.fetchData(); // 미체결 주문 목록 새로고침
                        } else {
                            showAlert('주문 취소에 실패했습니다: ' + response.error_message, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('주문 취소 오류:', error);
                        showAlert('주문 취소 중 오류가 발생했습니다.', 'error');
                    });
                
            }
        },

        modifyOrder(item) {
            console.log('주문 수정:', item);
            const { 종목코드, 종목명, 주문구분, 주문가격, 미체결수량 } = item;
            
            // 매수/매도 판별
            const isBuy = 주문구분.includes('매수');
            
            showBuySellCanvas({
                stk_code: 종목코드,
                stk_name: 종목명,
                which: isBuy ? '매수' : '매도',
                qty: Number(미체결수량),
                cost: Number(주문가격),
                isModify: true,
                ordNo: item.주문번호
            });
        },

        showDetail(item) {
            console.log('상세 정보:', item);
            
            // Modal의 각 필드에 데이터 설정
            document.getElementById('modal-order-no').textContent = item.주문번호;
            document.getElementById('modal-stock-name').textContent = item.종목명;
            document.getElementById('modal-stock-code').textContent = item.종목코드;
            document.getElementById('modal-order-type').innerHTML = 
                `<span class="${item.주문구분.includes('매수') ? 'text-danger' : 'text-primary'}">${item.주문구분}</span>`;
            document.getElementById('modal-trade-type').textContent = item.매매구분;
            document.getElementById('modal-order-price').textContent = Number(item.주문가격).toLocaleString() + '원';
            document.getElementById('modal-order-qty').textContent = Number(item.주문수량).toLocaleString() + '주';
            document.getElementById('modal-unfill-qty').textContent = Number(item.미체결수량).toLocaleString() + '주';
            document.getElementById('modal-fill-amount').textContent = Number(item.체결누계금액).toLocaleString() + '원';
            
            // 현재가 색상 적용
            const currentPriceElement = document.getElementById('modal-current-price');
            const priceClass = this.getPriceClass(item.현재가);
            currentPriceElement.innerHTML = `<span class="${priceClass}">${this.formatPriceText(item.현재가)}</span>`;
            
            document.getElementById('modal-buy-price').innerHTML = 
                `<span class="text-danger">${this.formatPriceText(item.매수호가)}</span>`;
            document.getElementById('modal-sell-price').innerHTML = 
                `<span class="text-primary">${this.formatPriceText(item.매도호가)}</span>`;
            document.getElementById('modal-order-status').innerHTML = 
                `<span class="${item.주문상태 === '접수' ? 'badge bg-info' : 'badge bg-secondary'}">${item.주문상태}</span>`;
            document.getElementById('modal-order-time').textContent = this.formatTime(item.시간);
            document.getElementById('modal-exchange').textContent = item.거래소구분텍스트;
            document.getElementById('modal-orig-order-no').textContent = item.원주문번호;
            
            // Modal 버튼 이벤트 설정
            const cancelBtn = document.getElementById('modal-cancel-order');
            const modifyBtn = document.getElementById('modal-modify-order');
            
            // 기존 이벤트 리스너 제거
            const newCancelBtn = cancelBtn.cloneNode(true);
            const newModifyBtn = modifyBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
            modifyBtn.parentNode.replaceChild(newModifyBtn, modifyBtn);
            
            // 새 이벤트 리스너 추가
            newCancelBtn.addEventListener('click', () => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('unfillOrderDetailModal'));
                modal.hide();
                this.cancelOrder(item);
            });
            
            newModifyBtn.addEventListener('click', () => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('unfillOrderDetailModal'));
                modal.hide();
                this.modifyOrder(item);
            });
            
            // Modal 표시
            const modal = new bootstrap.Modal(document.getElementById('unfillOrderDetailModal'));
            modal.show();
        },

        init() {
            console.log('미체결 주문 컴포넌트 초기화');
            this.fetchData();
        }
    };
}

function createKa10076Component() {
    return {
        title: '체결 주문',
        loading: false,
        items: [],
        
        fetchData() {
            this.loading = true;
            const payload = {
                stk_cd: '',      // 종목코드
                qry_tp: '0',     // 0:전체, 1:종목  
                sell_tp: '0',    // 0:전체, 1:매도, 2:매수
                ord_no: '',      // 주문번호
                stex_tp: '0'     // 0:통합, 1:KRX, 2:NXT
            };

            callKiwoomApi('ka10076', payload)
                .then(response => {
                    console.log('체결 주문 데이터:', response);
                    if (response.success && response.data) {
                        // API 응답에서 체결 주문 리스트 추출 (한글 키 사용)
                        this.items = response.data.체결 || [];
                        console.log('체결 주문 항목들:', this.items);
                    } else {
                        this.items = [];
                        console.error('체결 주문 데이터 오류:', response.error_message);
                    }
                })
                .catch(error => {
                    console.error('체결 주문 데이터 가져오기 오류:', error);
                    this.items = [];
                    showAlert('체결 주문 데이터를 가져오는데 실패했습니다.', 'error');
                })
                .finally(() => {
                    this.loading = false;
                });
        },

        formatTime(timeStr) {
            if (!timeStr) return '';
            // HHMMSS 형식을 HH:MM:SS로 변환
            if (timeStr.length === 6) {
                return `${timeStr.slice(0,2)}:${timeStr.slice(2,4)}:${timeStr.slice(4,6)}`;
            }
            return timeStr;
        },

        formatOrderPrice(priceStr, orderType) {
            if (!priceStr) return '시장가';
            const price = Number(priceStr);
            
            // 시장가 주문의 경우 (주문가격이 0)
            if (price === 0) {
                return '시장가';
            }
            
            return price.toLocaleString() + '원';
        },

        init() {
            console.log('체결 주문 컴포넌트 초기화');
            this.fetchData();
        }
    };
}

// Alpine.js 컴포넌트 등록
document.addEventListener('alpine:init', () => {
    Alpine.data('kt00004_component', createKt00004Component);
    Alpine.data('ka10075_component', createKa10075Component);
    Alpine.data('ka10076_component', createKa10076Component);
});
</script>
{% endraw %}
{% endblock %}
