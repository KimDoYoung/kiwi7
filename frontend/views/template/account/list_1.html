{% extends 'common/base.html' %}

{% block style %}
<style>
.kiwoom-loading { opacity: 0.6; }
.sortable-header { cursor: pointer; user-select: none; }
.sortable-header:hover { background-color: #f8f9fa; }
.clickable-cell { cursor: pointer; }
.clickable-cell:hover { background-color: #f0f0f0; }
.debug-info { font-size: 12px; color: #666; margin: 5px 0; }
</style>
{% endblock %}

{% block content %}
<div x-data="kt00004_component" @data-updated="console.log('Data updated event received')">
    <span x-text="name"></span>
    
    <!-- Ï¢ÖÌï© ÎîîÎ≤ÑÍπÖ Ï†ïÎ≥¥ -->
    <div class="debug-info">
        <strong>Debug Info:</strong><br>
        Loading: <span x-text="loading"></span> | 
        Data exists: <span x-text="!!data"></span><br>
        Config exists: <span x-text="!!_config"></span> | 
        Config key: <span x-text="_config ? 'kt00004' : 'missing'"></span><br>
        Summary config: <span x-text="!!_config?.summary"></span> | 
        Table config: <span x-text="!!_config?.table"></span><br>
        Data key: <span x-text="_config?.table?.data_key || 'missing'"></span><br>
        Sort key: <span x-text="sort_key || 'missing'"></span><br>
        <strong style="color: blue;">Summary rows (getter): <span x-text="summaryRows.length"></span></strong><br>
        <strong style="color: red;">Summary rows (function): <span x-text="getSummaryRows().length"></span></strong><br>
        Sorted items: <span x-text="sorted_items.length"></span><br>
        ÏßÅÏ†ëÏ†ëÍ∑º: <span x-text="data?.Ï¢ÖÎ™©Î≥ÑÍ≥ÑÏ¢åÌèâÍ∞ÄÌòÑÌô©?.length || 0"></span>
    </div>
    
    <div class="container mt-4">
        
        <!-- ÏóêÎü¨/ÏÑ±Í≥µ Î©îÏãúÏßÄ -->
        <div class="alert alert-danger" x-show="return_code !== 0">
            <strong>Ïò§Î•ò:</strong> <span x-text="return_msg"></span>
        </div>
        
        <!-- Ìó§Îçî -->
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <span x-text="data?.Í≥ÑÏ¢åÎ™Ö"></span>
                <span class="ms-2">(<span x-text="data?.ÏßÄÏ†êÎ™Ö"></span>)</span>
                <div class="form-check ms-3 mt-0">
                    <input class="form-check-input" type="checkbox" id="summaryFullCheck" x-model="summary_full">
                    <label class="form-check-label" for="summaryFullCheck">Ï†ÑÏ≤¥Î≥¥Í∏∞</label>
                </div>
            </div>
            
            <!-- Ïï°ÏÖò Î≤ÑÌäºÎì§ -->
            <div class="btn-group">
                <button class="btn btn-outline-secondary" @click="refresh()" :disabled="loading" title="ÏÉàÎ°úÍ≥†Ïπ®">
                    <i class="fa fa-refresh" :class="{'fa-spin': loading}"></i>
                </button>
                <button class="btn btn-outline-success" @click="exportCSV()" :disabled="!sorted_items.length" title="CSV ÎÇ¥Î≥¥ÎÇ¥Í∏∞">
                    <i class="fa fa-download"></i>
                </button>
            </div>
        </div>

        <!-- ÏöîÏïΩ ÌÖåÏù¥Î∏î (getter ÏÇ¨Ïö©) -->
        <div x-show="data">
            <h5 class="mt-3">ÏöîÏïΩ Ï†ïÎ≥¥</h5>
            <template x-if="summaryRows.length > 0">
                <div>
                    <h6>Hello...</h6>
                    <table class="mt-2 table table-bordered table-striped align-middle">
                        <tbody>
                            <template x-for="(row, index) in summaryRows" :key="index">
                                <tr>
                                    <template x-for="field in row" :key="field?.key || index + '_null'">
                                        <td colspan="2" x-if="!field"></td>
                                        <template x-if="field">
                                            <th class="bg-light" x-text="field.label"></th>
                                            <td class="text-end" 
                                                x-text="getSummaryValue(field)"
                                                :class="field.color_class || ''">
                                            </td>
                                        </template>
                                    </template>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </template>

            
            <!-- ÏöîÏïΩ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùÑ Îïå -->
            <template x-if="summaryRows.length === 0">
                <div class="alert alert-info">
                    ÏöîÏïΩ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.
                </div>
            </template>
        </div>

        <!-- Îç∞Ïù¥ÌÑ∞ ÌÖåÏù¥Î∏î -->
        <div class="mt-4">
            <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle text-center">
                    <thead class="table-light">
                        <tr>
                            <template x-for="column in getTableColumns()" :key="column.key">
                                <th>
                                    <template x-if="column.sortable">
                                        <a href="#" @click.prevent="sortBy(column.key)" 
                                           class="text-decoration-none text-dark sortable-header">
                                            <span x-text="column.label"></span>
                                            <span x-show="sort_key === column.key" 
                                                  x-text="sort_asc ? '‚ñ≤' : '‚ñº'"></span>
                                        </a>
                                    </template>
                                    <template x-if="!column.sortable">
                                        <span x-text="column.label"></span>
                                    </template>
                                </th>
                            </template>
                        </tr>
                    </thead>
                    <tbody x-show="data && !loading">
                        <template x-for="item in sorted_items" :key="item.Ï¢ÖÎ™©ÏΩîÎìú">
                            <tr>
                                <template x-for="column in getTableColumns()" :key="column.key">
                                    <td x-text="getCellValue(item, column)"
                                        :class="getCellClass(item, column) + (column.clickable ? ' clickable-cell' : '')"
                                        @click="handleCellClick(item, column)">
                                    </td>
                                </template>
                            </tr>
                        </template>
                    </tbody>
                    <tbody x-show="loading">
                        <tr>
                            <td :colspan="getTableColumns().length" class="text-center py-4">
                                <i class="fa fa-spinner fa-spin"></i> Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...
                            </td>
                        </tr>
                    </tbody>
                    <tbody x-show="!loading && (!data || sorted_items.length === 0)">
                        <tr>
                            <td :colspan="getTableColumns().length" class="text-center py-4 text-muted">
                                ÌëúÏãúÌï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>        
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script src="/public/js/configs/kiwoom-configs.js"></script>
<script src="/public/js/utils/kiwoom-utils.js"></script>
<script src="/public/js/components/kiwoom-base.js"></script>

<script>
document.addEventListener('alpine:init', () => {
    console.log('üöÄ Initializing kt00004_component');
    
    // Î®ºÏ†Ä ÏùòÏ°¥ÏÑ± ÌôïÏù∏
    console.log('üìã Dependencies check:', {
        KiwoomConfigs: !!window.KiwoomConfigs,
        KiwoomBase: !!window.KiwoomBase,
        KiwoomUtils: !!window.KiwoomUtils,
        kt00004Config: !!window.KiwoomConfigs?.kt00004
    });
    
    if (!window.KiwoomConfigs?.kt00004) {
        console.error('‚ùå kt00004 config not found!');
        return;
    }
    
    Alpine.data('kt00004_component', () => {
        console.log('üîß Creating component instance...');
        
        // Î≤†Ïù¥Ïä§ Ïª¥Ìè¨ÎÑåÌä∏ ÌôïÏû•
        let base;
        let config;
        
        try {
            base = window.KiwoomBase('kt00004');
            config = window.KiwoomConfigs.kt00004;
            console.log('‚úÖ Base component created:', !!base);
            console.log('‚úÖ Config loaded:', !!config);
        } catch (error) {
            console.error('‚ùå Error creating base component:', error);
            return {
                error: true,
                errorMessage: error.message
            };
        }
        
        const component = {
            ...base,
            
            // Ïª¥Ìè¨ÎÑåÌä∏ Ï¥àÍ∏∞Ìôî ÌôïÏù∏
            init() {
                console.log('üéØ Component init called');
                console.log('Config check in init:', {
                    hasConfig: !!this._config,
                    configSummary: !!this._config?.summary,
                    configTable: !!this._config?.table,
                    dataKey: this._config?.table?.data_key
                });
                
                // Î∂ÄÎ™® init Ìò∏Ï∂ú
                if (base.init) {
                    return base.init.call(this);
                }
            },
            
            // Computed propertyÎ°ú summary rows Ï∫êÏã±
            get summaryRows() {
                try {
                    return this.getSummaryRows();
                } catch (error) {
                    console.error('‚ùå Error in summaryRows getter:', error);
                    return [];
                }
            },

            // ÏöîÏïΩ ÌÖåÏù¥Î∏î Ìñâ ÏÉùÏÑ± (Îçî ÏïàÏ†ÑÌïú Î≤ÑÏ†Ñ)
            getSummaryRows() {
                console.log('üîç getSummaryRows called');
                
                try {
                    // null Ï≤¥ÌÅ¨
                    if (!this._config) {
                        console.error('‚ùå No _config in getSummaryRows');
                        return [];
                    }
                    
                    if (!this._config.summary) {
                        console.warn('‚ö†Ô∏è No summary config found, returning empty array');
                        return [];
                    }
                    
                    // basic_fieldsÍ∞Ä ÏóÜÏúºÎ©¥ Îπà Î∞∞Ïó¥Î°ú Ï≤òÎ¶¨
                    const basic = this._config.summary.basic_fields;
                    if (!basic || !Array.isArray(basic)) {
                        console.warn('‚ö†Ô∏è No basic_fields found');
                        return [];
                    }
                    
                    const extended = this.summary_full ? (this._config.summary.extended_fields || []) : [];
                    const allFields = [...basic, ...extended];
                    
                    console.log('üìã Summary fields:', { 
                        basicLength: basic.length, 
                        extendedLength: extended.length, 
                        totalLength: allFields.length 
                    });
                    
                    if (allFields.length === 0) {
                        console.warn('‚ö†Ô∏è No fields to display');
                        return [];
                    }
                    
                    const rows = [];
                    for (let i = 0; i < allFields.length; i += 2) {
                        rows.push([allFields[i], allFields[i + 1] || null]);
                    }
                    
                    console.log('‚úÖ Summary rows created:', rows.length);
                    return rows;
                    
                } catch (error) {
                    console.error('‚ùå Error in getSummaryRows:', error);
                    return []; // ÏóêÎü¨ Ïãú Îπà Î∞∞Ïó¥ Î∞òÌôò
                }
            },

            // ÌÖåÏù¥Î∏î Ïª¨Îüº Î∞òÌôò (Í∞ïÌôîÎêú ÏóêÎü¨ Ï≤òÎ¶¨)
            getTableColumns() {
                console.log('üîç getTableColumns called');
                
                try {
                    if (!this._config?.table?.columns) {
                        console.error('‚ùå No table columns config');
                        return [];
                    }
                    
                    const columns = this._config.table.columns;
                    console.log('üìä Table columns:', columns.length);
                    return columns;
                } catch (error) {
                    console.error('‚ùå Error in getTableColumns:', error);
                    return [];
                }
            },

            // Ï†ïÎ†¨Îêú ÏïÑÏù¥ÌÖú getter (Í∞ïÌôîÎêú Î≤ÑÏ†Ñ)
            get sorted_items() {
                console.log('üîç sorted_items getter called');
                
                try {
                    if (this.loading || !this.data) {
                        console.log('‚è≥ Loading or no data');
                        return [];
                    }
                    
                    if (!this._config?.table?.data_key) {
                        console.error('‚ùå No data_key in config');
                        return [];
                    }
                    
                    const dataKey = this._config.table.data_key;
                    const items = this.data[dataKey];
                    
                    console.log('üìä Items check:', {
                        dataKey,
                        hasItems: !!items,
                        isArray: Array.isArray(items),
                        length: Array.isArray(items) ? items.length : 'not array'
                    });
                    
                    if (!Array.isArray(items)) {
                        console.error('‚ùå Items not array or missing');
                        return [];
                    }
                    
                    // Ï†ïÎ†¨ ÏóÜÏù¥ Î®ºÏ†Ä Î∞òÌôòÌï¥Î≥¥Í∏∞
                    console.log('‚úÖ Returning items without sorting:', items.length);
                    return items;
                    
                } catch (error) {
                    console.error('‚ùå Error in sorted_items:', error);
                    return [];
                }
            },

            // ÏÖÄ ÌÅ¥Î¶≠ Ï≤òÎ¶¨
            handleCellClick(item, column) {
                if (column.key === 'Ï¢ÖÎ™©ÏΩîÎìú' || column.key === 'Ï¢ÖÎ™©Î™Ö') {
                    if (confirm(`${item.Ï¢ÖÎ™©Î™Ö}(${item.Ï¢ÖÎ™©ÏΩîÎìú}) ÏÉÅÏÑ∏ Ï†ïÎ≥¥Î•º Î≥¥ÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                        console.log('Navigate to stock detail:', item.Ï¢ÖÎ™©ÏΩîÎìú);
                    }
                }
            }
        };
        
        console.log('üéØ Component created:', component);
        return component;
    });
});
</script>
{% endblock %}