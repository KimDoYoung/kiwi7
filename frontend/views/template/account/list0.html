<!--
    - 이 템플릿은 계좌의 요약 정보와 종목별 평가 현황을 Alpine.js로 동적으로 표시합니다.
    - summary_full 체크박스로 상세 요약정보를 토글할 수 있습니다.
    - fetch_kiwoom() 함수는 API를 호출하여 데이터를 갱신합니다.
    - 각 데이터는 toLocaleString()으로 통화 형식으로 표시됩니다.
    - 손익금액/손익율은 양수/음수에 따라 색상이 다르게 표시됩니다.
TODO: 
    1. head click sorting, summary 더 예쁘게, 새로고침 5초마다 refrsh
    2. 종목코드 클릭, 종목명 클릭(상세정보)
    3. csv저장, 엑셀저장


-->
{% extends 'common/base.html' %}
{% block style %}
{% endblock %}
{% block content %}
<div class="container mt-4" x-data="kt00004_component">
    <!-- 계좌명과 헤드 시작-->
    <div class="d-flex align-items-center">
        <span x-text="data?.계좌명"></span>
        <span class="ms-2">(<span x-text="data?.지점명"></span>)</span>
        <div class="form-check ms-3 mt-0">
            <input class="form-check-input" type="checkbox" id="summaryFullCheck" x-model="summary_full">
            <label class="form-check-label" for="summaryFullCheck">전체보기</label>
        </div>
    </div>  
    <!-- 계좌명과 헤드 끝-->
     
    <!-- 데이터 테이블  시작-->
    <div class="mt-4">
        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle text-center">
                <thead class="table-light">
                    <tr>
                        <template x-for="column in getTableColumns()" :key="column.key">
                            <th>
                                <template x-if="column.sortable">
                                    <a href="#" @click.prevent="sortBy(column.key)" 
                                        class="text-decoration-none text-dark sortable-header">
                                        <span x-text="column.label"></span>
                                        <span x-show="sort_key === column.key" 
                                                x-text="sort_asc ? '▲' : '▼'"></span>
                                    </a>
                                </template>
                                <template x-if="!column.sortable">
                                    <span x-text="column.label"></span>
                                </template>
                            </th>
                        </template>
                    </tr>
                </thead>
                <tbody x-show="data && !loading">
                    <template x-for="item in get_sorted_items()" :key="item.종목코드">
                        <tr>
                            <template x-for="column in getTableColumns()" :key="column.key">
                                <td x-text="getCellValue(item, column)"
                                    :class="getCellClass(item, column) + (column.clickable ? ' clickable-cell' : '')"
                                    @click="handleCellClick(item, column)">
                                </td>
                            </template>
                        </tr>
                    </template>
                </tbody>
                <tbody x-show="loading">
                    <tr>
                        <td :colspan="getTableColumns().length" class="text-center py-4">
                            <i class="fa fa-spinner fa-spin"></i> 데이터를 불러오는 중...
                        </td>
                    </tr>
                </tbody>
                <tbody x-show="!loading && (!data || get_sorted_items().length === 0)">
                    <tr>
                        <td :colspan="getTableColumns().length" class="text-center py-4 text-muted">
                            표시할 데이터가 없습니다.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>        
    </div> 
    <!-- 데이터 테이블 끝-->   
</div>
{% raw %}
<!--handlebar scripts-->
{% endraw %}
{% endblock %}
{% block script %}
<script src="/public/js/configs/kiwoom-configs.js"></script>
<script src="/public/js/utils/kiwoom-utils.js"></script>
<script src="/public/js/components/kiwoom-base.js"></script>
{% raw %}
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('kt00004_component', () => {
            let base = window.KiwoomBase('kt00004');
            const component = {
                ...base,
                config: window.KiwoomConfigs['kt00004'],
                init(){
                    if(base.init){
                        return base.init.call(this);
                    } 
                },
                // get sorted_items() {
                //     let items = this.data?.[this.config.table.data_key] || [];
                //     const sortedItems = window.KiwoomUtils.sortArray([...items], this.sort_key, this.sort_asc);
                //     // console.log('✅ Returning sorted items:', sortedItems.length, 'items');
                //     return sortedItems;
                // }
            }
            return component;
        });        
    });

        // Alpine.data('kt00004_component', () => ({
        //     data: null,
        //     return_msg : null,
        //     return_code : 0,
        //     sort_key : '종목코드',
        //     sort_asc : true,

        //     summary_full : false, //전체보기

        //     sortBy(key) {
        //         if (this.sort_key === key) {
        //             this.sort_asc = !this.sort_asc;
        //         } else {
        //             this.sort_key = key;
        //             this.sort_asc = true;
        //         }
        //     },            
        //     get sorted_items() {
        //         if (!this.data?.종목별계좌평가현황) return [];

        //         return [...this.data.종목별계좌평가현황].sort((a, b) => {
        //             let valA = a[this.sort_key];
        //             let valB = b[this.sort_key];

        //             // 숫자인 경우 정렬
        //             if (!isNaN(parseFloat(valA)) && !isNaN(parseFloat(valB))) {
        //                 valA = parseFloat(valA);
        //                 valB = parseFloat(valB);
        //             }

        //             if (valA < valB) return this.sort_asc ? -1 : 1;
        //             if (valA > valB) return this.sort_asc ? 1 : -1;
        //             return 0;
        //         });
        //     },            
        //     async fetch_kiwoom() {
        //         try {
        //             const payload = {
        //                 qry_tp: "0",
        //                 dmst_stex_tp: "KRX"
        //             };

        //             // 계좌평가현황요청
        //             const response = await callKiwoomApi('kt00004', payload);
        //             if (response.success) {
        //                 this.data = response.data
        //                 this.return_msg = response.data.return_msg || '주문이 성공적으로 처리되었습니다.';
        //                 this.return_code = response.data.return_code
        //                 console.log('응답:', response.data);
        //             } else {
        //                 throw new Error(response.error_message || '알 수 없는 오류가 발생했습니다.');
        //             }
        //         } catch (err) {
        //             if (err instanceof KiwiError) {
        //                 this.error = `에러 ${err.status}: ${err.message}`;
        //             } else {
        //                 this.error = '에러: ' + err.message;
        //             }
        //             console.error('주문 처리 오류:', err);
        //             this.return_code = -1;
        //             this.return_msg = '오류 발생: ' + err.message;
        //         }
        //     }
        // }))
    // });
</script>
{% endraw %}
{% endblock %}
