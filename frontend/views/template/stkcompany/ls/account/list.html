<!--
    - t0424(LS 주식잔고조회)
    - 이 템플릿은 LS 계좌의 요약 정보와 종목별 평가 현황을 Alpine.js로 동적으로 표시합니다.
-->
{% extends 'common/base.html' %}
{% block style %}
<style>
    .spin {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .clickable-cell {
        cursor: pointer;
    }

    .clickable-cell:hover {
        background-color: #f8f9fa;
    }

    .sortable-header {
        cursor: pointer;
    }

    .sortable-header:hover {
        background-color: #e9ecef;
    }

    [x-cloak] {
        display: none !important;
    }
</style>
{% endblock %}
{% block content %}
<div class="container mx-auto px-4 mt-4" x-data="t0424_component">

    <!-- 계좌명과 헤드 시작-->
    <div class="flex items-center">
        <span class="font-bold text-lg">LS증권 계좌</span>


    </div>
    <div class="flex items-center mt-2 gap-4 text-sm">
        <div>
            <span>자산:</span>
            <span class="font-bold" x-text="Number(data?.t0424OutBlock?.평가금액 || 0).toLocaleString() + ' 원'"></span>
        </div>
        <div>
            <span>수익:</span>
            <span class="font-bold" x-text="Number(data?.t0424OutBlock?.평가손익 || 0).toLocaleString() + ' 원'"
                :class="formatClass(data?.t0424OutBlock?.평가손익)"></span>
        </div>
        <div>
            <span>매수가능:</span>
            <span class="font-bold" x-text="Number(data?.t0424OutBlock?.추정D2예수금 || 0).toLocaleString() + ' 원'"></span>
        </div>
        <div class="ml-auto">
            <div class="form-control mt-0">
                <label class="label cursor-pointer gap-2">
                    <span class="label-text font-bold">
                        자동 새로고침
                        <span x-show="!autoRefresh" class="badge badge-secondary ml-1">30초</span>
                        <span x-show="autoRefresh"
                            :class="`badge ml-1 ${countdown <= 5 ? 'badge-warning' : 'badge-primary'}`"
                            x-text="`${countdown}초`"></span>
                    </span>
                    <input type="checkbox" class="toggle toggle-primary toggle-sm" id="autoRefreshCheck"
                        x-model="autoRefresh" />
                </label>
            </div>
        </div>
    </div>
    <!-- 계좌명과 헤드 끝-->


    <div class="mt-4">
        <div class="mt-2 mb-2 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <select aria-label="손익율 필터" class="select select-bordered select-sm w-auto" x-model="profitFilter">
                    <option value="all">전체</option>
                    <option value="plus">+손익율</option>
                    <option value="minus">-손익율</option>
                </select>
                <div>종목갯수 : <span x-text="filtered_item_count"></span> / <span x-text="total_item_count"></span>
                </div>
            </div>
            <div class="flex gap-2">
                <button class="btn btn-outline btn-success btn-sm" title="엑셀로 저장" @click="exportCSV()">
                    <i class="bi bi-file-earmark-excel"></i>
                </button>
                <button class="btn btn-outline btn-success btn-sm" title="My Stock에 저장" @click="addMyStock()">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="table table-zebra table-hover text-center w-full">
                <thead class="bg-base-200">
                    <tr>
                        <template x-for="column in getTableColumns()" :key="column.key">
                            <th>
                                <template x-if="column.sortable">
                                    <a href="#" @click.prevent="sortBy(column.key)"
                                        class="no-underline text-base-content sortable-header">
                                        <span x-text="column.label"></span>
                                        <span x-show="sort_key === column.key" x-text="sort_asc ? '▲' : '▼'"></span>
                                    </a>
                                </template>
                                <template x-if="!column.sortable">
                                    <span x-text="column.label"></span>
                                </template>
                            </th>
                        </template>
                        <template x-if="hasActionButtons()">
                            <th>Actions</th>
                        </template>
                    </tr>
                </thead>
                <tbody x-show="data && !loading">
                    <template x-for="(item, index) in sorted_items" :key="item.종목번호 || index">
                        <tr>
                            <template x-for="column in getTableColumns()" :key="column.key">
                                <td x-text="getCellValue(item, column)"
                                    :class="getCellClass(item, column) + (column.clickable ? ' clickable-cell' : '') + ((column.format === 'number' || column.format === 'profit') ? ' text-right' : '')"
                                    @click="handleCellClick(item, column)">
                                </td>
                            </template>
                            <template x-if="hasActionButtons()">
                                <td>
                                    <div class="join" role="group">
                                        <template x-if="actions.includes('buy')">
                                            <button type="button" class="btn btn-sm btn-error join-item"
                                                @click="buy(item)" title="매수(buy)">買</button>
                                        </template>
                                        <template x-if="actions.includes('sell')">
                                            <button type="button" class="btn btn-sm btn-info join-item"
                                                @click="sell(item)" title="매도(sell)">賣</button>
                                        </template>
                                        <template x-if="actions.includes('detail')">
                                            <button type="button" class="btn btn-sm btn-success join-item"
                                                @click="detail(item)" title="종목상세(detail info)">詳</button>
                                        </template>
                                    </div>
                                </td>
                            </template>
                        </tr>
                    </template>
                </tbody>
                <tbody x-show="loading">
                    <tr>
                        <td :colspan="getTableColumns().length" class="text-center py-4">
                            <i class="bi bi-arrow-clockwise spin"></i> 데이터를 불러오는 중...
                        </td>
                    </tr>
                </tbody>
                <tbody x-show="!loading && (!data || sorted_items.length === 0)">
                    <tr>
                        <td :colspan="getTableColumns().length" class="text-center py-4 text-base-content/50">
                            표시할 데이터가 없습니다.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <!-- 데이터 테이블 끝-->
</div>

{% raw %}
<!--handlebar scripts-->
{% endraw %}
{% endblock %}
{% block script %}
<script src="/public/js/configs/ls/t0424.js"></script>
<script src="/public/js/utils/kiwi7-utils.js"></script>
<script src="/public/js/components/kiwi7-base.js"></script>
{% raw %}
<script>
    // Alpine 컴포넌트 팩토리 함수
    function createT0424Component() {
        const base = window.createKiwi7Base(t0424, {
            callApi: callLsApi,
            utils: window.Kiwi7Utils,
            debug: false,
            title: 'stocklist'
        });

        return {
            ...base,

            // === 상태 변수 ===
            summary_show: false,
            profit: 0,
            profitFilter: 'all',
            autoRefresh: false,           // 자동 새로고침 스위치 상태
            countdownInterval: null,      // 카운트다운 인터벌 ID
            countdown: 30,                // 카운트다운 값

            // === 초기화 ===
            init() {
                this.initializeBase();
                this.setupWatchers();
                this.setupAutoRefreshWatcher();
                this.setupCleanup();
                this.registerCallbacks();
                this.registerClickHandlers();
            },

            initializeBase() {
                if (base.init) {
                    base.init.call(this);
                }
            },

            setupWatchers() {
                this.$watch('profitFilter', (newValue, oldValue) => {
                    console.log('profitFilter changed from', oldValue, 'to', newValue);
                    this.clearFilters();
                    this.onProfitFilterChange(newValue);
                });
            },

            // === 자동 새로고침 관리 ===
            setupAutoRefreshWatcher() {
                // autoRefresh 상태 변화 감지
                this.$watch('autoRefresh', (newValue) => {
                    if (newValue) {
                        this.startAutoRefresh();
                    } else {
                        this.stopAutoRefresh();
                    }
                });
            },

            setupCleanup() {
                // 페이지 언로드 시 인터벌 정리
                window.addEventListener('beforeunload', () => {
                    this.stopAutoRefresh();
                });
            },

            startAutoRefresh() {
                console.log('자동 새로고침 시작 (30초 간격)');
                this.countdown = 30;

                // 카운트다운 시작 (1초마다)
                this.countdownInterval = setInterval(() => {
                    if (this.autoRefresh) {
                        this.countdown--;

                        if (this.countdown <= 0) {
                            // 카운트다운이 0이 되면 새로고침 실행
                            if (!this.loading) {
                                console.log('자동 새로고침 실행...');
                                this.fetch_data(); // kiwi7-base의 fetch_data 함수 호출
                            }
                            this.countdown = 30; // 카운트다운 리셋
                        }
                    }
                }, 1000); // 1초마다 카운트다운
            },

            stopAutoRefresh() {
                console.log('자동 새로고침 중지');
                if (this.countdownInterval) {
                    clearInterval(this.countdownInterval);
                    this.countdownInterval = null;
                }
                this.countdown = 30; // 카운트다운 리셋
            },

            registerCallbacks() {
                this.addCallback((data) => {
                    // LS 데이터는 t0424OutBlock에 요약 정보가 있음
                    const summary = data?.t0424OutBlock;
                    if (summary) {
                        this.profit = Number(summary['평가손익합계']) || 0;
                    }
                });
            },

            registerClickHandlers() {
                this.addClickHandler('종목명', (item) => {
                    console.log('종목명 클릭:', item);
                    showCompanyCanvas(item.종목번호);
                });
            },

            // === 계산된 속성 ===
            get sorted_items() {
                return this.sortedItems();
            },

            get total_item_count() {
                return this.totalItemCount() || 0;
            },

            get filtered_item_count() {
                return this.filteredItemCount();
            },

            get actions() {
                return this.getActions();
            },

            // === 필터링 메서드 ===
            onProfitFilterChange(filterValue) {
                console.log('필터가 변경되었습니다:', filterValue);
                this.clearFilters();

                switch (filterValue) {
                    case 'plus':
                        // LS 키: 수익율
                        this.addFilter(item => Number(item.수익율) > 0);
                        break;
                    case 'minus':
                        // LS 키: 수익율
                        this.addFilter(item => Number(item.수익율) < 0);
                        break;
                    // 'all'은 필터를 추가하지 않음
                }
            },

            // === 액션 메서드 ===
            buy(item) {
                console.log('구매:', item);
                // LS 키: 평균단가
                const { 종목번호: stk_code, 종목명: stk_name, 평균단가 } = item;

                showBuySellCanvas({
                    stk_code,
                    stk_name,
                    which: '매수',
                    qty: 1,
                    cost: 평균단가 || 0
                });
            },

            sell(item) {
                console.log('판매:', item);
                // LS 키: 잔고수량
                const { 종목번호: stk_code, 종목명: stk_name, 잔고수량 } = item;
                const qty = Number(잔고수량) || 0;

                showBuySellCanvas({
                    stk_code,
                    stk_name,
                    which: '매도',
                    qty,
                    cost: 0
                });
            },

            detail(item) {
                console.log('상세 정보:', item);
                window.open(`/page?path=stock/detail&stk_cd=${item.종목번호}`, '_blank');
            },

            // === 유틸리티 메서드 ===
            formatClass(value) {
                if (value > 0) return 'text-red-500';
                if (value < 0) return 'text-blue-500';
                return '';
            },
            addMyStock() {
                // LS 데이터 구조 (t0424OutBlock1: 리스트)
                let list = this.data?.t0424OutBlock1 || [];
                let codes = []
                for (let i = 0; i < list.length; i++) {
                    let code = list[i]["종목번호"]
                    if (code) {
                        if (!/^[0-9]+$/.test(code)) {
                            code = code.replace(/[^0-9]/g, '')
                        }
                        codes.push(code)
                    }
                }
                if (codes.length === 0) {
                    showAlert('추가할 종목이 없습니다.', 'warning');
                    return;
                }

                postFetch('/api/v1/mystock/bulk', {
                    api_id: 'kiwi7_mystock_bulk_add',
                    payload: {
                        codes: codes
                    },
                }).then(response => {
                    if (response.success) {
                        showAlert('My Stock에 추가되었습니다.', 'success');
                    } else {
                        showAlert('My Stock 추가에 실패했습니다: ' + response.error_message, 'error');
                    }
                });
                console.log('My Stock에 추가:', codes);
            }
        };
    }

    // Alpine.js 컴포넌트 등록
    document.addEventListener('alpine:init', () => {
        Alpine.data('t0424_component', createT0424Component);
    });
</script>
{% endraw %}
{% endblock %}