<!--
    - kt00004(계좌평가현황), kt10075(미체결요청), kt100076(체결요청) 
    - 이 템플릿은 계좌의 요약 정보와 종목별 평가 현황을 Alpine.js로 동적으로 표시합니다.
    - summary_full 체크박스로 상세 요약정보를 토글할 수 있습니다.
    - fetch_kiwoom() 함수는 API를 호출하여 데이터를 갱신합니다.
    - 각 데이터는 toLocaleString()으로 통화 형식으로 표시됩니다.
    - 손익금액/손익율은 양수/음수에 따라 색상이 다르게 표시됩니다.
-->
{% extends 'common/base.html' %}
{% block style %}
{% endblock %}
{% block content %}
<div class="container mx-auto px-4 mt-4" x-data="kt00004_component">
    <!-- 계좌명과 헤드 시작-->
    <div class="flex items-center">
        <span x-text="data?.계좌명" class="font-bold text-lg"></span>
        <span class="ml-2">(<span x-text="data?.지점명"></span>)</span>


    </div>
    <div class="flex items-center mt-2 gap-4 text-sm">
        <div>
            <span>자산:</span>
            <span class="font-bold" x-text="Number(data?.추정예탁자산).toLocaleString() + ' 원'"></span>
        </div>
        <div>
            <span>수익:</span>
            <span class="font-bold" x-text="profit.toLocaleString() + ' 원'" :class="formatClass(profit)"></span>
        </div>
        <div>
            <span>매수가능:</span>
            <span class="font-bold" x-text="Number(data?.['D+2추정예수금']).toLocaleString() + ' 원'"></span>
        </div>
        <div class="ml-auto">
            <div class="form-control mt-0">
                <label class="label cursor-pointer gap-2">
                    <span class="label-text font-bold">
                        자동 새로고침
                        <span x-show="!autoRefresh" class="badge badge-secondary ml-1">30초</span>
                        <span x-show="autoRefresh"
                            :class="`badge ml-1 ${countdown <= 5 ? 'badge-warning' : 'badge-primary'}`"
                            x-text="`${countdown}초`"></span>
                    </span>
                    <input type="checkbox" class="toggle toggle-primary toggle-sm" id="autoRefreshCheck"
                        x-model="autoRefresh" />
                </label>
            </div>
        </div>
    </div>
    <!-- 계좌명과 헤드 끝-->


    <div class="mt-4">
        <div class="mt-2 mb-2 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <select aria-label="손익율 필터" class="select select-bordered select-xs w-auto" x-model="profitFilter">
                    <option value="all">전체</option>
                    <option value="plus">+손익율</option>
                    <option value="minus">-손익율</option>
                </select>
                <div class="text-xs">종목 <span x-text="filtered_item_count" class="font-bold"></span> / <span
                        x-text="total_item_count"></span></div>
            </div>
            <div class="flex gap-2">
                <button class="btn btn-outline btn-success btn-xs" title="엑셀로 저장" @click="exportCSV()">
                    <i class="bi bi-file-earmark-excel"></i> CSV
                </button>
                <button class="btn btn-outline btn-success btn-xs" title="My Stock에 저장" @click="addMyStock()">
                    <i class="bi bi-plus-lg"></i> My Stock
                </button>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="table table-xs table-pin-rows table-zebra text-center w-full">
                <thead class="bg-base-200 font-bold text-base-content">
                    <tr>
                        <template x-for="column in getTableColumns()" :key="column.key">
                            <th :class="getCellClass({}, column)" class="align-middle">
                                <template x-if="column.sortable">
                                    <a href="#" @click.prevent="sortBy(column.key)"
                                        class="no-underline text-base-content sortable-header flex items-center gap-1"
                                        :class="column.align === 'right' ? 'justify-end' : (column.align === 'center' ? 'justify-center' : 'justify-start')">
                                        <span x-text="column.label"></span>
                                        <span class="text-[10px]" x-show="sort_key === column.key"
                                            x-text="sort_asc ? '▲' : '▼'"></span>
                                    </a>
                                </template>
                                <template x-if="!column.sortable">
                                    <div
                                        :class="column.align === 'right' ? 'text-right' : (column.align === 'center' ? 'text-center' : 'text-left')">
                                        <span x-text="column.label"></span>
                                    </div>
                                </template>
                            </th>
                        </template>
                        <template x-if="hasActionButtons()">
                            <th class="text-center">관리</th>
                        </template>
                    </tr>
                </thead>
                <tbody x-show="data && !loading">
                    <template x-for="item in sorted_items" :key="item.종목코드">
                        <tr class="hover">
                            <template x-for="column in getTableColumns()" :key="column.key">
                                <td x-text="getCellValue(item, column)" class="py-1 px-2"
                                    :class="getCellClass(item, column) + (column.clickable ? ' clickable-cell font-bold cursor-pointer hover:underline' : '') + ((column.format === 'number' || column.format === 'profit') ? ' text-right' : '')"
                                    @click="column.clickable ? handleCellClick(item, column) : null">
                                </td>
                            </template>
                            <template x-if="hasActionButtons()">
                                <td class="py-1">
                                    <div class="flex gap-1 justify-center" role="group">
                                        <template x-if="actions.includes('buy')">
                                            <button type="button" class="btn btn-xs btn-error btn-outline"
                                                @click="buy(item)" title="매수">買</button>
                                        </template>
                                        <template x-if="actions.includes('sell')">
                                            <button type="button" class="btn btn-xs btn-info btn-outline"
                                                @click="sell(item)" title="매도">賣</button>
                                        </template>
                                        <template x-if="actions.includes('detail')">
                                            <button type="button" class="btn btn-xs btn-success btn-outline"
                                                @click="detail(item)" title="상세">詳</button>
                                        </template>
                                    </div>
                                </td>
                            </template>
                        </tr>
                    </template>
                </tbody>
                <tbody x-show="loading">
                    <tr>
                        <td :colspan="getTableColumns().length + 1" class="text-center py-10">
                            <span class="loading loading-spinner loading-md text-primary"></span>
                            <div class="mt-2 text-xs">데이터를 불러오는 중...</div>
                        </td>
                    </tr>
                </tbody>
                <tbody x-show="!loading && (!data || sorted_items.length === 0)">
                    <tr>
                        <td :colspan="getTableColumns().length + 1" class="text-center py-10 text-base-content/50">
                            <i class="bi bi-inbox text-4xl block mb-2"></i>
                            표시할 데이터가 없습니다.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
<div class="container mx-auto px-4 mt-4" x-data="ka10075_component">
    <!-- 미체결 주문: 데이터 있을 때만 전체 영역 표시 -->
    <template x-if="items.length > 0">
        <div>
            <div class="flex justify-between items-center mb-3">
                <h5 x-text="title" class="mb-0 text-sm font-bold text-base-content/80"></h5>
                <div class="flex items-center gap-2">
                    <small class="text-base-content/70 text-xs">총 <span x-text="items.length"></span>건</small>
                    <button class="btn btn-outline btn-primary btn-xs" @click="fetchData()" :disabled="loading">
                        <i class="bi bi-arrow-clockwise" :class="{'spin': loading}"></i> 새로고침
                    </button>
                </div>
            </div>
            <div x-show="loading" class="text-center py-4 text-xs">
                <i class="bi bi-arrow-clockwise spin"></i> 미체결 데이터를 불러오는 중...
            </div>
            <div x-show="!loading && items.length > 0" class="overflow-x-auto">
                <table class="table table-xs table-pin-rows table-zebra text-center w-full">
                    <thead class="bg-base-200 font-bold text-base-content">
                        <tr>
                            <th>시간</th>
                            <th>종목명</th>
                            <th>주문구분</th>
                            <th>주문가격</th>
                            <th>주문수량</th>
                            <th>미체결수량</th>
                            <th>현재가</th>
                            <th>주문상태</th>
                            <th>거래소</th>
                            <th>관리</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="item in items" :key="item.주문번호">
                            <tr class="hover">
                                <td x-text="formatTime(item.시간)"></td>
                                <td x-text="item.종목명" class="text-left font-bold"></td>
                                <td>
                                    <span :class="item.주문구분.includes('매수') ? 'text-red-600' : 'text-blue-600'"
                                        x-text="item.주문구분"></span>
                                </td>
                                <td x-text="Number(item.주문가격).toLocaleString() + '원'" class="text-right"></td>
                                <td x-text="Number(item.주문수량).toLocaleString() + '주'" class="text-right"></td>
                                <td x-text="Number(item.미체결수량).toLocaleString() + '주'"
                                    class="text-right font-bold text-warning"></td>
                                <td class="text-right">
                                    <span :class="getPriceClass(item.현재가)" x-text="formatPriceText(item.현재가)"></span>
                                </td>
                                <td>
                                    <span
                                        :class="item.주문상태 === '접수' ? 'badge badge-info badge-xs' : 'badge badge-ghost badge-xs'"
                                        x-text="item.주문상태"></span>
                                </td>
                                <td x-text="item.거래소구분텍스트"></td>
                                <td class="py-1">
                                    <div class="join join-horizontal" role="group">
                                        <button type="button" class="btn btn-xs btn-outline btn-error join-item"
                                            @click="cancelOrder(item)" title="주문취소">취소</button>
                                        <button type="button" class="btn btn-xs btn-outline btn-info join-item"
                                            @click="modifyOrder(item)" title="주문수정">수정</button>
                                        <button type="button" class="btn btn-xs btn-outline btn-success join-item"
                                            @click="showDetail(item)" title="상세정보">詳</button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </template>
</div>

<div class="container mx-auto px-4 mt-4" x-data="ka10076_component">
    <!-- 체결 주문: 데이터 있을 때만 전체 영역 표시 -->
    <template x-if="items.length > 0">
        <div>
            <div class="flex justify-between items-center mb-3">
                <h5 x-text="title" class="mb-0 text-sm font-bold text-base-content/80"></h5>
                <div class="flex items-center gap-2">
                    <small class="text-base-content/70 text-xs">총 <span x-text="items.length"></span>건</small>
                    <button class="btn btn-outline btn-primary btn-xs" @click="fetchData()" :disabled="loading">
                        <i class="bi bi-arrow-clockwise" :class="{'spin': loading}"></i> 새로고침
                    </button>
                </div>
            </div>
            <div x-show="loading" class="text-center py-4 text-xs">
                <i class="bi bi-arrow-clockwise spin"></i> 체결 데이터를 불러오는 중...
            </div>
            <div x-show="!loading && items.length > 0" class="overflow-x-auto">
                <table class="table table-xs table-pin-rows table-zebra text-center w-full">
                    <thead class="bg-base-200 font-bold text-base-content">
                        <tr>
                            <th>주문시간</th>
                            <th>종목명</th>
                            <th>주문구분</th>
                            <th>매매구분</th>
                            <th>주문가격</th>
                            <th>체결가</th>
                            <th>주문수량</th>
                            <th>체결량</th>
                            <th>미체결수량</th>
                            <th>수수료</th>
                            <th>세금</th>
                            <th>주문상태</th>
                            <th>거래소</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="item in items" :key="item.주문번호">
                            <tr class="hover">
                                <td x-text="formatTime(item.주문시간)"></td>
                                <td x-text="item.종목명" class="text-left font-bold"></td>
                                <td>
                                    <span :class="item.주문구분.includes('매수') ? 'text-red-600' : 'text-blue-600'"
                                        x-text="item.주문구분"></span>
                                </td>
                                <td x-text="item.매매구분"></td>
                                <td class="text-right">
                                    <span x-text="formatOrderPrice(item.주문가격, item.매매구분)"></span>
                                </td>
                                <td x-text="Number(item.체결가).toLocaleString() + '원'"
                                    class="text-right font-bold text-success"></td>
                                <td x-text="Number(item.주문수량).toLocaleString() + '주'" class="text-right"></td>
                                <td x-text="Number(item.체결량).toLocaleString() + '주'"
                                    class="text-right font-bold text-blue-600"></td>
                                <td x-text="Number(item.미체결수량).toLocaleString() + '주'" class="text-right"></td>
                                <td x-text="Number(item.당일매매수수료).toLocaleString() + '원'"
                                    class="text-right text-base-content/60"></td>
                                <td x-text="Number(item.당일매매세금).toLocaleString() + '원'"
                                    class="text-right text-base-content/60"></td>
                                <td>
                                    <span class="badge badge-success badge-xs" x-text="item.주문상태"></span>
                                </td>
                                <td x-text="item.거래소구분텍스트"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </template>
</div>

<!-- 미체결 주문 상세 정보 Modal (DaisyUI) -->
<dialog id="unfillOrderDetailModal" class="modal">
    <div class="modal-box w-11/12 max-w-5xl">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
        </form>
        <h3 class="font-bold text-lg" id="unfillOrderDetailModalLabel">미체결 주문 상세 정보</h3>
        <div class="py-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <table class="table table-sm">
                        <tbody>
                            <tr>
                                <th class="bg-base-200 w-1/3">주문번호</th>
                                <td id="modal-order-no"></td>
                            </tr>
                            <tr>
                                <th class="bg-base-200">종목명</th>
                                <td id="modal-stock-name"></td>
                            </tr>
                            <tr>
                                <th class="bg-base-200">종목코드</th>
                                <td id="modal-stock-code"></td>
                            </tr>
                            <tr>
                                <th class="bg-base-200">주문구분</th>
                                <td id="modal-order-type"></td>
                            </tr>
                            <tr>
                                <th class="bg-base-200">매매구분</th>
                                <td id="modal-trade-type"></td>
                            </tr>
                            <tr>
                                <th class="bg-base-200">주문가격</th>
                                <td id="modal-order-price"></td>
                            </tr>
                            <tr>
                                <th class="bg-base-200">주문수량</th>
                                <td id="modal-order-qty"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div>
                    <table class="table table-sm">
                        <tbody>
                            <tr>
                                <th class="bg-base-200 w-1/3">미체결수량</th>
                                <td id="modal-unfill-qty" class="font-bold text-warning"></td>
                            </tr>
                            <tr>
                                <th class="bg-base-200">체결누계금액</th>
                                <td id="modal-fill-amount"></td>
                            </tr>
                            <tr>
                                <th class="bg-base-200">현재가</th>
                                <td id="modal-current-price"></td>
                            </tr>
                            <tr>
                                <th class="bg-base-200">매수호가</th>
                                <td id="modal-buy-price"></td>
                            </tr>
                            <tr>
                                <th class="bg-base-200">매도호가</th>
                                <td id="modal-sell-price"></td>
                            </tr>
                            <tr>
                                <th class="bg-base-200">주문상태</th>
                                <td id="modal-order-status"></td>
                            </tr>
                            <tr>
                                <th class="bg-base-200">주문시간</th>
                                <td id="modal-order-time"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="mt-4">
                <div class="flex justify-between items-center p-3 bg-base-200 rounded-lg">
                    <div>
                        <strong>거래소:</strong> <span id="modal-exchange"></span>
                    </div>
                    <div>
                        <strong>원주문번호:</strong> <span id="modal-orig-order-no"></span>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-action">
            <button type="button" class="btn btn-outline btn-error" id="modal-cancel-order">주문 취소</button>
            <button type="button" class="btn btn-outline btn-info" id="modal-modify-order">주문 수정</button>
            <form method="dialog">
                <button class="btn">닫기</button>
            </form>
        </div>
    </div>
</dialog>

{% raw %}
<!--handlebar scripts-->
{% endraw %}
{% endblock %}
{% block script %}
<script src="/public/js/configs/kiwoom/kt00004.js"></script>
<script src="/public/js/utils/kiwi7-utils.js"></script>
<script src="/public/js/components/kiwi7-base.js"></script>
{% raw %}
<script>
    // Alpine 컴포넌트 팩토리 함수
    function createKt00004Component() {
        const base = window.createKiwi7Base(kt00004, {
            callApi: callKiwoomApi,
            utils: window.Kiwi7Utils,
            debug: false,
            title: 'stocklist'
        });

        return {
            ...base,

            // === 상태 변수 ===
            summary_show: false,
            profit: 0,
            profitFilter: 'all',
            autoRefresh: false,           // 자동 새로고침 스위치 상태
            countdownInterval: null,      // 카운트다운 인터벌 ID
            countdown: 30,                // 카운트다운 값

            // === 초기화 ===
            init() {
                this.initializeBase();
                this.setupWatchers();
                this.setupAutoRefreshWatcher();
                this.setupCleanup();
                this.registerCallbacks();
                this.registerClickHandlers();
            },

            initializeBase() {
                if (base.init) {
                    base.init.call(this);
                }
            },

            setupWatchers() {
                this.$watch('profitFilter', (newValue, oldValue) => {
                    console.log('profitFilter changed from', oldValue, 'to', newValue);
                    this.clearFilters();
                    this.onProfitFilterChange(newValue);
                });
            },

            // === 자동 새로고침 관리 ===
            setupAutoRefreshWatcher() {
                // autoRefresh 상태 변화 감지
                this.$watch('autoRefresh', (newValue) => {
                    if (newValue) {
                        this.startAutoRefresh();
                    } else {
                        this.stopAutoRefresh();
                    }
                });
            },

            setupCleanup() {
                // 페이지 언로드 시 인터벌 정리
                window.addEventListener('beforeunload', () => {
                    this.stopAutoRefresh();
                });
            },

            startAutoRefresh() {
                console.log('자동 새로고침 시작 (30초 간격)');
                this.countdown = 30;

                // 카운트다운 시작 (1초마다)
                this.countdownInterval = setInterval(() => {
                    if (this.autoRefresh) {
                        this.countdown--;

                        if (this.countdown <= 0) {
                            // 카운트다운이 0이 되면 새로고침 실행
                            if (!this.loading) {
                                console.log('자동 새로고침 실행...');
                                this.fetch_data(); // kiwi7-base의 fetch_data 함수 호출
                            }
                            this.countdown = 30; // 카운트다운 리셋
                        }
                    }
                }, 1000); // 1초마다 카운트다운
            },

            stopAutoRefresh() {
                console.log('자동 새로고침 중지');
                if (this.countdownInterval) {
                    clearInterval(this.countdownInterval);
                    this.countdownInterval = null;
                }
                this.countdown = 30; // 카운트다운 리셋
            },
            //데이터를 가져온 후 처리
            registerCallbacks() {
                this.addCallback((data) => {
                    // debugger;
                    let data_list = data?.종목별계좌평가현황 || [];
                    let total_money = Number(data?.총매입금액)
                    for (let i = 0; i < data_list.length; i++) {
                        let avgcost = Number(data_list[i]['평균단가']);
                        let qty = Number(data_list[i]['보유수량']);
                        data_list[i]['보유비중'] = parseFloat((avgcost * qty / total_money * 100).toFixed(2));
                    }
                });


                //this.addCallback((data) => {
                //    debugger;
                //    let data_list = data?.output1 || [];
                //    let total_money =  Number(data?.output2["매입금액합계금액"])
                //    for (let i = 0; i < data_list.length; i++) {
                //        let avgcost = Number(data_list[i]['매입평균가격']);
                //        let qty = Number(data_list[i]['보유수량']);
                //        data_list[i]['보유금액'] = avgcost * qty / total_money * 100;
                //    }
                //});
            },

            registerClickHandlers() {
                this.addClickHandler('종목명', (item) => {
                    console.log('종목명 클릭:', item);
                    showCompanyCanvas(item.종목코드);
                });
            },

            // === 계산된 속성 ===
            get sorted_items() {
                return this.sortedItems();
            },

            get total_item_count() {
                return this.totalItemCount() || 0;
            },

            get filtered_item_count() {
                return this.filteredItemCount();
            },

            get actions() {
                return this.getActions();
            },

            // === 필터링 메서드 ===
            onProfitFilterChange(filterValue) {
                console.log('필터가 변경되었습니다:', filterValue);
                this.clearFilters();

                switch (filterValue) {
                    case 'plus':
                        this.addFilter(item => item.손익율 > 0);
                        break;
                    case 'minus':
                        this.addFilter(item => item.손익율 < 0);
                        break;
                    // 'all'은 필터를 추가하지 않음
                }
            },

            // === 액션 메서드 ===
            buy(item) {
                console.log('구매:', item);
                const { 종목코드: stk_code, 종목명: stk_name, 매입가 } = item;

                showBuySellCanvas({
                    stk_code,
                    stk_name,
                    which: '매수',
                    qty: 1,
                    cost: 매입가 || 0
                });
            },

            sell(item) {
                console.log('판매:', item);
                const { 종목코드: stk_code, 종목명: stk_name, 보유수량 } = item;
                const qty = Number(보유수량) || 0;

                showBuySellCanvas({
                    stk_code,
                    stk_name,
                    which: '매도',
                    qty,
                    cost: 0
                });
            },

            detail(item) {
                console.log('상세 정보:', item);
                //showCompanyCanvas(item.종목코드);
                //윈도우 open 하면서 /page?path=stock/detail&stk_cd=${item.종목코드}
                window.open(`/page?path=stock/detail&stk_cd=${item.종목코드}`, '_blank');
                //window.location.href = `/page?path=stock/detail&stk_cd=${item.종목코드}`;
            },

            // === 유틸리티 메서드 ===
            formatClass(value) {
                if (value > 0) return 'text-red-600';
                if (value < 0) return 'text-blue-600';
                return '';
            },
            addMyStock() {
                let list = this.data["종목별계좌평가현황"]
                let codes = []
                for (let i = 0; i < list.length; i++) {
                    code = list[i]["종목코드"]
                    if (!/^[0-9]+$/.test(code)) {
                        code = code.replace(/[^0-9]/g, '')
                    }
                    codes.push(code)
                }
                postFetch('/api/v1/mystock/bulk', {
                    api_id: 'kiwi7_mystock_bulk_add',
                    payload: {
                        codes: codes
                    },
                }).then(response => {
                    if (response.success) {
                        showAlert('My Stock에 추가되었습니다.', 'success');
                    } else {
                        showAlert('My Stock 추가에 실패했습니다: ' + response.error_message, 'error');
                    }
                });
                console.log('My Stock에 추가:', this.data);
                // My Stock에 추가하는 로직 구현
            }
        };
    }

    function createKa10075Component() {
        return {
            title: '미체결 주문',
            loading: false,
            items: [],

            fetchData() {
                this.loading = true;
                const payload = {
                    all_stk_tp: '0', // 0:전체, 1:종목
                    trde_tp: '0',    // 0:전체, 1:매도, 2:매수
                    stk_cd: '',      // 종목코드 (all_stk_tp가 1일 때 사용)
                    stex_tp: '0'     // 0:통합, 1:KRX, 2:NXT
                };

                callKiwoomApi('ka10075', payload)
                    .then(response => {
                        console.log('미체결 주문 데이터:', response);
                        if (response.success && response.data) {
                            // API 응답에서 미체결 주문 리스트 추출 (한글 키 사용)
                            this.items = response.data.미체결 || [];
                            console.log('미체결 주문 항목들:', this.items);
                        } else {
                            this.items = [];
                            console.error('미체결 주문 데이터 오류:', response.error_message);
                        }
                    })
                    .catch(error => {
                        console.error('미체결 주문 데이터 가져오기 오류:', error);
                        this.items = [];
                        showAlert('미체결 주문 데이터를 가져오는데 실패했습니다.', 'error');
                    })
                    .finally(() => {
                        this.loading = false;
                    });
            },

            formatTime(timeStr) {
                if (!timeStr) return '';
                // HHMMSS 형식을 HH:MM:SS로 변환
                if (timeStr.length === 6) {
                    return `${timeStr.slice(0, 2)}:${timeStr.slice(2, 4)}:${timeStr.slice(4, 6)}`;
                }
                return timeStr;
            },

            formatPrice(priceStr) {
                if (!priceStr) return '0원';
                // 현재가에서 +/- 부호 제거하고 숫자만 추출
                const price = priceStr.toString().replace(/[+-]/g, '');
                const numPrice = Number(price);
                if (isNaN(numPrice)) return priceStr;

                return numPrice.toLocaleString() + '원';
            },

            formatPriceText(priceStr) {
                if (!priceStr) return '0원';
                // 현재가에서 +/- 부호 제거하고 숫자만 추출
                const price = priceStr.toString().replace(/[+-]/g, '');
                const numPrice = Number(price);
                if (isNaN(numPrice)) return priceStr;

                return numPrice.toLocaleString() + '원';
            },

            getPriceClass(priceStr) {
                if (!priceStr) return '';
                // 원래 값이 음수였다면 파란색, 양수면 빨간색
                const isNegative = priceStr.toString().startsWith('-');
                return isNegative ? 'text-blue-600' : 'text-red-600';
            },

            cancelOrder(item) {
                console.log('주문 취소:', item);
                const confirmMsg = `${item.종목명} ${item.주문구분} 주문을 취소하시겠습니까?\n주문번호: ${item.주문번호}`;

                if (confirm(confirmMsg)) {
                    const api_id = "kt10003";
                    const payload = {
                        "dmst_stex_tp": item.거래소구분텍스트, //국내거래소구분
                        "orig_ord_no": item.주문번호, //원주문번호
                        "stk_cd": item.종목코드, //종목코드
                        "cncl_qty": item.미체결수량 //취소수량
                    }
                    console.log(payload);
                    callKiwoomApi(api_id, payload)
                        .then(response => {
                            console.log('주문 취소 응답:', response);
                            if (response.success) {
                                showAlert('주문이 성공적으로 취소되었습니다.', 'success');
                                this.fetchData(); // 미체결 주문 목록 새로고침
                            } else {
                                showAlert('주문 취소에 실패했습니다: ' + response.error_message, 'error');
                            }
                        })
                        .catch(error => {
                            console.error('주문 취소 오류:', error);
                            showAlert('주문 취소 중 오류가 발생했습니다.', 'error');
                        });

                }
            },

            modifyOrder(item) {
                console.log('주문 수정:', item);
                const { 종목코드, 종목명, 주문구분, 주문가격, 미체결수량 } = item;

                // 매수/매도 판별
                const isBuy = 주문구분.includes('매수');

                showBuySellCanvas({
                    stk_code: 종목코드,
                    stk_name: 종목명,
                    which: isBuy ? '매수' : '매도',
                    qty: Number(미체결수량),
                    cost: Number(주문가격),
                    isModify: true,
                    ordNo: item.주문번호
                });
            },

            showDetail(item) {
                console.log('상세 정보:', item);

                // Modal의 각 필드에 데이터 설정
                document.getElementById('modal-order-no').textContent = item.주문번호;
                document.getElementById('modal-stock-name').textContent = item.종목명;
                document.getElementById('modal-stock-code').textContent = item.종목코드;
                document.getElementById('modal-order-type').innerHTML =
                    `<span class="${item.주문구분.includes('매수') ? 'text-red-600' : 'text-blue-600'}">${item.주문구분}</span>`;
                document.getElementById('modal-trade-type').textContent = item.매매구분;
                document.getElementById('modal-order-price').textContent = Number(item.주문가격).toLocaleString() + '원';
                document.getElementById('modal-order-qty').textContent = Number(item.주문수량).toLocaleString() + '주';
                document.getElementById('modal-unfill-qty').textContent = Number(item.미체결수량).toLocaleString() + '주';
                document.getElementById('modal-fill-amount').textContent = Number(item.체결누계금액).toLocaleString() + '원';

                // 현재가 색상 적용
                const currentPriceElement = document.getElementById('modal-current-price');
                const priceClass = this.getPriceClass(item.현재가);
                currentPriceElement.innerHTML = `<span class="${priceClass}">${this.formatPriceText(item.현재가)}</span>`;

                document.getElementById('modal-buy-price').innerHTML =
                    `<span class="text-red-600">${this.formatPriceText(item.매수호가)}</span>`;
                document.getElementById('modal-sell-price').innerHTML =
                    `<span class="text-blue-600">${this.formatPriceText(item.매도호가)}</span>`;
                document.getElementById('modal-order-status').innerHTML =
                    `<span class="${item.주문상태 === '접수' ? 'badge badge-info' : 'badge badge-ghost'}">${item.주문상태}</span>`;
                document.getElementById('modal-order-time').textContent = this.formatTime(item.시간);
                document.getElementById('modal-exchange').textContent = item.거래소구분텍스트;
                document.getElementById('modal-orig-order-no').textContent = item.원주문번호;

                // Modal 버튼 이벤트 설정
                const cancelBtn = document.getElementById('modal-cancel-order');
                const modifyBtn = document.getElementById('modal-modify-order');

                // 기존 이벤트 리스너 제거
                const newCancelBtn = cancelBtn.cloneNode(true);
                const newModifyBtn = modifyBtn.cloneNode(true);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                modifyBtn.parentNode.replaceChild(newModifyBtn, modifyBtn);

                // 새 이벤트 리스너 추가
                newCancelBtn.addEventListener('click', () => {
                    const modal = document.getElementById('unfillOrderDetailModal');
                    modal.close();
                    this.cancelOrder(item);
                });

                newModifyBtn.addEventListener('click', () => {
                    const modal = document.getElementById('unfillOrderDetailModal');
                    modal.close();
                    this.modifyOrder(item);
                });

                // Modal 표시
                document.getElementById('unfillOrderDetailModal').showModal();
            },

            init() {
                console.log('미체결 주문 컴포넌트 초기화');
                this.fetchData();
            }
        };
    }

    function createKa10076Component() {
        return {
            title: '체결 주문',
            loading: false,
            items: [],

            fetchData() {
                this.loading = true;
                const payload = {
                    stk_cd: '',      // 종목코드
                    qry_tp: '0',     // 0:전체, 1:종목  
                    sell_tp: '0',    // 0:전체, 1:매도, 2:매수
                    ord_no: '',      // 주문번호
                    stex_tp: '0'     // 0:통합, 1:KRX, 2:NXT
                };

                callKiwoomApi('ka10076', payload)
                    .then(response => {
                        console.log('체결 주문 데이터:', response);
                        if (response.success && response.data) {
                            // API 응답에서 체결 주문 리스트 추출 (한글 키 사용)
                            this.items = response.data.체결 || [];
                            console.log('체결 주문 항목들:', this.items);
                        } else {
                            this.items = [];
                            console.error('체결 주문 데이터 오류:', response.error_message);
                        }
                    })
                    .catch(error => {
                        console.error('체결 주문 데이터 가져오기 오류:', error);
                        this.items = [];
                        showAlert('체결 주문 데이터를 가져오는데 실패했습니다.', 'error');
                    })
                    .finally(() => {
                        this.loading = false;
                    });
            },

            formatTime(timeStr) {
                if (!timeStr) return '';
                // HHMMSS 형식을 HH:MM:SS로 변환
                if (timeStr.length === 6) {
                    return `${timeStr.slice(0, 2)}:${timeStr.slice(2, 4)}:${timeStr.slice(4, 6)}`;
                }
                return timeStr;
            },

            formatOrderPrice(priceStr, orderType) {
                if (!priceStr) return '시장가';
                const price = Number(priceStr);

                // 시장가 주문의 경우 (주문가격이 0)
                if (price === 0) {
                    return '시장가';
                }

                return price.toLocaleString() + '원';
            },

            init() {
                console.log('체결 주문 컴포넌트 초기화');
                this.fetchData();
            }
        };
    }

    // Alpine.js 컴포넌트 등록
    document.addEventListener('alpine:init', () => {
        Alpine.data('kt00004_component', createKt00004Component);
        Alpine.data('ka10075_component', createKa10075Component);
        Alpine.data('ka10076_component', createKa10076Component);
    });
</script>
{% endraw %}
{% endblock %}