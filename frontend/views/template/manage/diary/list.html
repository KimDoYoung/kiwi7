{% extends 'common/base.html' %}
{% block style %}
{% endblock %}
{% block content %}
<div x-data="diaryListFilter" class="container mt-4">
    <h4 class="mb-3"><i class="bi bi-journal-text me-2 text-success"></i>주식 일지 목록</h4>
    <form class="row g-2 align-items-end mb-4" @submit.prevent="searchDiary">
        <div class="col-md-3">
            <label for="ymd_from" class="form-label">시작 날짜</label>
            <input type="date" id="ymd_from" class="form-control" x-model="filter.ymd_from">
        </div>
        <div class="col-md-3">
            <label for="ymd_to" class="form-label">종료 날짜</label>
            <input type="date" id="ymd_to" class="form-control" x-model="filter.ymd_to">
        </div>
        <div class="col-md-2">
            <label for="stk_cd" class="form-label">종목코드</label>
            <input type="text" id="stk_cd" class="form-control" x-model="filter.stk_cd" maxlength="6" placeholder="예: 005930">
        </div>
        <div class="col-md-3">
            <label for="note_like" class="form-label">내용 검색</label>
            <input type="text" id="note_like" class="form-control" x-model="filter.note_like" placeholder="메모, 키워드 등">
        </div>
        <div class="col-md-1 d-grid">
            <div class="d-flex gap-1">
                <button type="submit" class="btn btn-success" title="검색">
                    <i class="bi bi-search"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" title="초기화" @click="resetFilters()">
                    <i class="bi bi-arrow-counterclockwise"></i>
                </button>
            </div>
        </div>
    </form>
    <div>
        <!-- 일지 목록 테이블 -->
        <table class="table table-bordered table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th style="width:130px; white-space:nowrap;">날짜</th>
                    <th style="width:120px; white-space:nowrap;">종목코드</th>
                    <th>내용</th>
                    <th style="width:130px; white-space:nowrap;">수정일</th>
                    <th class="text-center" style="width:110px;">동작</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="item in diaryList" :key="item.id">
                    <tr>
                        <td x-text="formatYmd(item.ymd)" style="white-space:nowrap;"></td>
                        <td x-text="item.stk_cd || '-'" class="text-primary" style="white-space:nowrap;"></td>
                        <td x-text="item.note"></td>
                        <td x-text="formatYmd(item.updated_at)" style="white-space:nowrap;"></td>
                        <td class="text-center">
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-primary" @click="editDiary(item)">
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" @click="deleteDiary(item.id)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                </template>
                <tr x-show="diaryList.length === 0">
                    <td colspan="6" class="text-center text-muted">검색 결과가 없습니다.</td>
                </tr>
            </tbody>
        </table>
        <!-- 페이징 영역 -->
        <nav x-show="pagination.total_pages > 1" aria-label="페이지네이션" class="mt-3">
            <ul class="pagination justify-content-center">
                <li class="page-item" :class="{disabled: pagination.page === 1}">
                    <a class="page-link" href="#" @click.prevent="goPage(pagination.page - 1)"><i class="bi bi-chevron-left"></i></a>
                </li>
                <template x-for="p in pagination.total_pages" :key="p">
                    <li class="page-item" :class="{active: p === pagination.page}">
                        <a class="page-link" href="#" @click.prevent="goPage(p)">
                            <span x-text="p"></span>
                        </a>
                    </li>
                </template>
                <li class="page-item" :class="{disabled: pagination.page === pagination.total_pages}">
                    <a class="page-link" href="#" @click.prevent="goPage(pagination.page + 1)"><i class="bi bi-chevron-right"></i></a>
                </li>
            </ul>
        </nav>
    </div>
</div>
{% endblock %}
{% block script %}
{% raw %}
<script>
function diaryListFilter() {
    return {
        filter: {
            ymd_from: '',
            ymd_to: '',
            stk_cd: '',
            note_like: ''
        },
        diaryList: [],
        pagination: { total: 0, page: 1, limit: 20, total_pages: 1 },
        async searchDiary(page = 1) {
            // 날짜 변환 (YYYY-MM-DD → YYYYMMDD)
            const ymd_from = this.filter.ymd_from ? this.filter.ymd_from.replace(/-/g, '') : null;
            const ymd_to = this.filter.ymd_to ? this.filter.ymd_to.replace(/-/g, '') : null;
            if (typeof page === 'object') page = 1;
            const payload = {
                ymd_from: this.filter.ymd_from ? this.filter.ymd_from.replace(/-/g, '') : null,
                ymd_to: this.filter.ymd_to ? this.filter.ymd_to.replace(/-/g, '') : null,
                stk_cd: this.filter.stk_cd ? this.filter.stk_cd : null,
                note_like: this.filter.note_like ? this.filter.note_like : null,
                page,
                limit: this.pagination.limit
            };
            try {
                const res = await postFetch('/api/v1/diary/list', { api_id: 'diary_list', payload });
                if (res.success && res.data && Array.isArray(res.data.list)) {
                    this.diaryList = res.data.list;
                    this.pagination = res.data.pagination;
                } else {
                    this.diaryList = [];
                    this.pagination = { total: 0, page: 1, limit: 20, total_pages: 1 };
                }
            } catch (e) {
                this.diaryList = [];
                this.pagination = { total: 0, page: 1, limit: 20, total_pages: 1 };
            }
        },
        goPage(page) {
            if (page < 1 || page > this.pagination.total_pages) return;
            this.searchDiary(page);
        },
        formatYmd(val) {
            // YYYYMMDD 또는 YYYY-MM-DD 또는 null
            if (!val) return '-';
            if (val.length === 8) {
                return val.slice(0,4) + '-' + val.slice(4,6) + '-' + val.slice(6,8);
            }
            if (val.length >= 10 && val.includes('-')) {
                return val.slice(0,10);
            }
            return val;
        },
        editDiary(item) {
            if (typeof showDiaryModal === 'function') {
                showDiaryModal(item);                
            }
        },
        deleteDiary(id) {
            if (confirm('정말 삭제하시겠습니까?')) {
                deleteFetch('/api/v1/diary/' + id)
                    .then(res => {
                        if (res.success) {
                            showAlert('삭제되었습니다.', 'success');
                            this.searchDiary(this.pagination.page);
                        } else {
                            showAlert(res.message || '삭제에 실패했습니다.', 'error');
                        }
                    })
                    .catch(err => {
                        showAlert(err.message || '삭제 중 오류가 발생했습니다.', 'error');
                    }); 
            }
        },
        resetFilters() {
            this.filter = {
                ymd_from: '',
                ymd_to: '',
                stk_cd: '',
                note_like: ''
            };
            this.searchDiary(1);
        },
        init(){
            this.searchDiary();
        }
    }
}

document.addEventListener('alpine:init', () => {
    Alpine.data('diaryListFilter', diaryListFilter);
});
</script>
{% endraw %}
{% endblock %}
