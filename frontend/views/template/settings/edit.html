{% extends 'common/base.html' %}
{% block style %}
{% endblock %}
{% block content %}
<div x-data="data_settings"  class="container mt-4">
    <h2>설정 편집</h2>
    <div class="mt-3">
        <button type="button" class="btn btn-primary" @click="issue_new_token()">키움 토큰 재발급</button>
        <div x-show="result" class="alert alert-info mt-3" x-text="result"></div>
    </div>
    <hr class="my-3">
    <div class="mt-3 stk_info_fill">
        <p>종목의 기본정보 테이블(stk_info)을 다시 강제로 채웁니다. 이 테이블은 종목찾기에서 사용되며 종목코드에 해당하는 종목명을 찾는 것 등에 사용됩니다.
        <p>최종 동작시각: <span x-text="stk_info.last_fill_time || '정보 없음'" class="badge bg-secondary"></span>
        <p><button type="button" 
                   class="btn btn-primary" 
                   @click="fill_stk_info()"
                   :disabled="stk_info.loading">
            <span x-show="!stk_info.loading">
                <i class="fas fa-sync-alt me-1"></i>주식종목정보 채우기
            </span>
            <span x-show="stk_info.loading">
                <i class="fas fa-spinner fa-spin me-1"></i>업데이트 중...
            </span>
        </button>
        <div x-show="stk_info.result" 
             :class="stk_info.success ? 'alert alert-success' : 'alert alert-danger'" 
             class="mt-3"
             x-transition>
            <i :class="stk_info.success ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle'" class="me-2"></i>
            <span x-text="stk_info.result"></span>
        </div>
    </div>
</div>
{% raw %}
<!--handlebar scripts-->
{% endraw %}
{% endblock %}
{% block script %}
<script>
// Alpine 컴포넌트 팩토리 함수
function createSettingsComponent() {
    return {
        // === 상태 변수 ===
        data: null,
        result: null,
        stk_info: {
            result: null,
            last_fill_time: '{{data.last_stk_info_fill or ""}}',
            success: false,
            loading: false
        },
        // === 초기화 ===
        init() {
            console.log('Initializing data_settings');
        },

        // === API 호출 메서드 ===
        async issue_new_token() {
            console.log('토큰 재발급요청...');
            this.result = null;
            
            try {
                const response = await getFetch('/api/v1/kiwoom/issue-new-token');
                console.log(response);
                
                this.result = response.success 
                    ? '토큰이 성공적으로 재발급되었습니다.'
                    : `토큰 재발급에 실패했습니다. ${response.message || '관리자에게 문의하세요.'}`;
                    
            } catch (error) {
                console.error('토큰 재발급 오류:', error);
                this.result = `토큰 재발급에 실패했습니다. ${error.message || '관리자에게 문의하세요.'}`;
            }
        },

        async fill_stk_info() {
            console.log("stk_info 테이블 채우기");
            
            // 초기화
            this.stk_info.result = null;
            this.stk_info.loading = true;
            
            try {
                const response = await putFetch('/api/v1/settings/stk_info?force=true');
                console.log(response);
                  
                if (response.success) {
                    this.stk_info.result = 'stk_info 테이블이 성공적으로 업데이트되었습니다.';
                    this.stk_info.success = true;
                    
                    // 서버에서 받은 실제 업데이트 시간 사용
                    if (response.data && response.data.last_stk_info_fill) {
                        this.stk_info.last_fill_time = response.data.last_stk_info_fill;
                    } else {
                        // 서버에서 시간을 받지 못한 경우 현재 시간으로 fallback
                        this.stk_info.last_fill_time = new Date().toLocaleString('ko-KR');
                    }
                } else {
                    this.stk_info.result = `업데이트에 실패했습니다. ${response.message || '관리자에게 문의하세요.'}`;
                    this.stk_info.success = false;
                }
                    
            } catch (error) {
                console.error('stk_info 테이블 채우기 오류:', error);
                this.stk_info.result = `업데이트에 실패했습니다. ${error.message || '네트워크 오류가 발생했습니다.'}`;
                this.stk_info.success = false;
            } finally {
                this.stk_info.loading = false;
                
                // 3초 후 결과 메시지 자동 사라짐
                setTimeout(() => {
                    this.stk_info.result = null;
                }, 3000);
            }
        }
    };
}

// Alpine.js 컴포넌트 등록
document.addEventListener('alpine:init', () => {
    Alpine.data('data_settings', createSettingsComponent);
});
</script>
{% endblock %}